<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAP Inventory Validator (v13 - Pro + Smart Logic)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f8fafc;
            font-family: 'Segoe UI', sans-serif;
            min-height: 100vh;
            margin: 0;
        }

        /* Meril-V Branding Background */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('background.png') no-repeat center center fixed;
            background-size: cover;
            /* White Overlay for readability */
            box-shadow: inset 0 0 0 1000px rgba(255, 255, 255, 0.90);
            z-index: -1;
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 15px -1px rgba(0, 0, 0, 0.05);
        }

        /* V13 Table Resize Handles */
        th {
            position: relative;
        }

        .resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            /* Wider for easier grabbing */
            cursor: col-resize;
            user-select: none;
            height: 100%;
            z-index: 10;
            /* Ensure on top */
        }

        .resizer:hover,
        .resizing {
            background-color: #3b82f6;
            /* Blue highlight */
            width: 7px;
        }

        /* SUPER FILTER UI */
        .super-filter-panel {
            position: absolute;
            background: white;
            width: 280px;
            max-height: 400px;
            display: flex;
            flex-direction: column;
            border-radius: 8px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 1px solid #e2e8f0;
            z-index: 100;
            font-family: ui-sans-serif, system-ui;
        }

        .filter-header {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            border-radius: 8px 8px 0 0;
        }

        .filter-body {
            padding: 8px;
            overflow-y: auto;
            flex: 1;
        }

        .filter-footer {
            padding: 10px;
            border-top: 1px solid #f1f5f9;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            background: #f8fafc;
            border-radius: 0 0 8px 8px;
        }

        .filter-row {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            font-size: 13px;
            color: #334155;
            border-radius: 4px;
            cursor: pointer;
        }

        .filter-row:hover {
            background: #f1f5f9;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            background: #eff6ff;
            color: #1d4ed8;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid #dbeafe;
            margin-right: 4px;
            margin-bottom: 4px;
        }

        .filter-chip button {
            margin-left: 6px;
            color: #60a5fa;
            cursor: pointer;
        }

        .filter-chip button:hover {
            color: #1e40af;
        }

        .active-filter-icon {
            transition: all 0.2s;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .default-serial {
            background-color: #fef08a !important;
            color: #854d0e !important;
            font-weight: bold;
            border: 1px solid #eab308;
        }

        /* Headers */
        th {
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
            white-space: nowrap;
            /* Prevent breaking */
        }

        th:hover {
            background-color: #cbd5e1;
        }

        .th-phy {
            background-color: #eff6ff;
            color: #1e3a8a;
            border-bottom: 2px solid #bfdbfe;
        }

        .th-sys {
            background-color: #f0fdf4;
            color: #14532d;
            border-bottom: 2px solid #bbf7d0;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
    <style id="columnVisibilityStyles"></style>
</head>

<body class="p-4 text-gray-800">

    <div class="w-full max-w-[99%] mx-auto">
        <header
            class="glass-header p-4 rounded-xl flex flex-col md:flex-row justify-between items-center mb-6 gap-4 border border-white/50">
            <div class="flex items-center gap-5">
                <img src="logo.png" alt="Meril-V" class="h-12 w-auto object-contain drop-shadow-sm">
                <div class="border-l-2 border-slate-200 pl-4">
                    <h1 class="text-xl font-bold text-slate-800 tracking-tight leading-none">Inventory Validator</h1>
                    <p class="text-[10px] uppercase tracking-[0.2em] text-slate-500 font-bold mt-1">Warehouse Management
                        System</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleSettingsPage()"
                    class="bg-purple-50 hover:bg-purple-100 text-purple-700 px-4 py-2 rounded text-sm font-bold border border-purple-200 transition">
                    <i class="fas fa-cog mr-1"></i> Settings
                </button>
                <button
                    onclick="document.getElementById('layoutModal').classList.remove('hidden'); loadLayoutToEditor(activeLayoutId);"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-bold shadow transition">
                    <i class="fas fa-table mr-1"></i> Layout Manager
                </button>
                <button onclick="runDiagnostics()"
                    class="bg-yellow-50 hover:bg-yellow-100 text-yellow-700 px-4 py-2 rounded text-sm font-bold border border-yellow-200 transition">
                    <i class="fas fa-vial mr-1"></i> Test
                </button>
                <button onclick="showAbout()"
                    class="bg-blue-50 hover:bg-blue-100 text-blue-700 px-4 py-2 rounded text-sm font-bold border border-blue-200 transition">
                    <i class="fas fa-info-circle mr-1"></i> Help
                </button>
                <button onclick="location.reload()"
                    class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded text-sm font-bold text-gray-700 transition">
                    <i class="fas fa-sync-alt mr-1"></i> Reset
                </button>
            </div>
        </header>

        <div id="settingsPage"
            class="hidden w-full max-w-[98%] mx-auto pb-10 bg-white p-6 rounded shadow border-t-4 border-purple-600 animate-fade">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 class="text-2xl font-bold text-gray-800"><i
                        class="fas fa-cogs text-purple-600 mr-2"></i>Configuration & Settings</h2>
                <button onclick="toggleSettingsPage()"
                    class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded text-sm font-bold text-gray-800 transition">
                    <i class="fas fa-arrow-left mr-1"></i> Back to Dashboard
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

                <div class="bg-gray-50 p-5 rounded border border-gray-200">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center"><i
                            class="fas fa-user-tie text-blue-600 mr-2"></i>Customer Configuration</h3>
                    <div class="mb-3">
                        <label class="block text-xs font-bold text-gray-700 mb-1">Customer Name</label>
                        <input type="text" id="custName" placeholder="Enter Customer Name"
                            class="w-full border p-2 text-sm rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="mb-3">
                        <label class="block text-xs font-bold text-gray-700 mb-1">Project / Site ID</label>
                        <input type="text" id="custProject" placeholder="E.g. WH-DXB-01"
                            class="w-full border p-2 text-sm rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div class="bg-purple-50 p-5 rounded border border-purple-200">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center"><i
                            class="fas fa-database text-purple-600 mr-2"></i>Master Data Management</h3>
                    <div class="mb-3">
                        <label class="block text-xs font-bold text-gray-700 mb-1">Upload Material Master (Excel)</label>
                        <div class="text-[10px] text-gray-500 mb-2">Required Columns: <b>Material</b>,
                            <b>Description</b>
                        </div>
                        <input type="file" id="fileMaster" onchange="loadMasterData()"
                            class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:bg-white file:text-purple-700 hover:file:bg-purple-100 cursor-pointer border rounded bg-white p-1" />
                    </div>
                    <div class="bg-white p-3 rounded border h-24 overflow-auto">
                        <div class="flex justify-between items-center mb-1 text-xs border-b pb-1">
                            <span class="font-bold text-gray-500">Loaded Items</span>
                            <span id="masterCount" class="bg-purple-200 text-purple-800 px-2 rounded font-bold">0</span>
                        </div>
                        <ul id="masterList" class="text-xs text-gray-600 space-y-1">
                            <li class="italic text-gray-400">No master data loaded...</li>
                        </ul>
                    </div>
                </div>

                <div class="bg-blue-50 p-5 rounded border border-blue-200">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center"><i
                            class="fas fa-users text-blue-600 mr-2"></i>Customer Master Data</h3>
                    <div class="mb-3">
                        <label class="block text-xs font-bold text-gray-700 mb-1">Upload Customer Master (Excel)</label>
                        <div class="text-[10px] text-gray-500 mb-2">Required Columns: <b>Customer Code</b>,
                            <b>Customer Name</b>
                        </div>
                        <input type="file" id="fileCustomerMaster" onchange="loadCustomerMasterData()"
                            class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:bg-white file:text-blue-700 hover:file:bg-blue-100 cursor-pointer border rounded bg-white p-1" />
                    </div>
                    <div class="bg-white p-3 rounded border h-24 overflow-auto">
                        <div class="flex justify-between items-center mb-1 text-xs border-b pb-1">
                            <span class="font-bold text-gray-500">Loaded Customers</span>
                            <span id="custMasterCount" class="bg-blue-200 text-blue-800 px-2 rounded font-bold">0</span>
                        </div>
                        <ul id="custMasterList" class="text-xs text-gray-600 space-y-1">
                            <li class="italic text-gray-400">No customer data loaded...</li>
                        </ul>
                    </div>
                </div>

                <div class="bg-white p-5 rounded border border-gray-300">
                    <h4 class="text-sm font-bold text-gray-800 mb-3"><i class="fas fa-barcode mr-1"></i> GS1 AI Code
                        Configuration</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Material Code</label>
                            <select id="aiMaterial"
                                class="w-full border p-2 text-sm rounded focus:ring-2 focus:ring-blue-500">
                                <option value="240">(240) Additional Product ID</option>
                                <option value="01">(01) GTIN</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Batch Code</label>
                            <select id="aiBatch"
                                class="w-full border p-2 text-sm rounded focus:ring-2 focus:ring-blue-500">
                                <option value="10">(10) Batch/Lot Number</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Serial Code</label>
                            <select id="aiSerial"
                                class="w-full border p-2 text-sm rounded focus:ring-2 focus:ring-blue-500">
                                <option value="21">(21) Serial Number</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="bg-indigo-50 p-5 rounded border border-indigo-200">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center"><i
                            class="fas fa-table text-indigo-600 mr-2"></i>Export Layout Manager</h3>
                    <div class="mb-3">
                        <label class="block text-xs font-bold text-gray-700 mb-1">Define Export Columns (Order
                            Matters)</label>
                        <textarea id="exportLayout" rows="4"
                            class="w-full border p-2 text-xs rounded font-mono focus:ring-2 focus:ring-indigo-500"
                            onchange="saveSettings()" placeholder="Enter column keys separated by comma..."></textarea>
                        <p class="text-[10px] text-gray-500 mt-1">Keys: Status, Logic, Material, Description, Customer,
                            P_ID, S.Loc, Plant, Phy Batch, Phy Serial, Sys Batch, Sys Serial, Condition, Expiry Date,
                            Sys Expiry, Days Left, Stock Status, Comment</p>
                    </div>
                </div>

                <div class="bg-purple-50 p-3 rounded border border-purple-200 mt-3">
                    <h4 class="text-xs font-bold text-purple-800 mb-2"><i class="fas fa-warehouse mr-1"></i> Storage
                        Locations</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-600">Good Stock S.Loc</label>
                            <input type="text" id="txtGoodSloc" value="RT01"
                                class="w-full text-xs p-1 border rounded text-purple-700 font-bold">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-600">Damage/Expired S.Loc</label>
                            <input type="text" id="txtDmgSloc" value="DMG1"
                                class="w-full text-xs p-1 border rounded text-purple-700 font-bold">
                        </div>
                    </div>
                </div>

                <div class="bg-gray-100 p-5 rounded border border-gray-300">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center"><i
                            class="fas fa-sliders-h text-gray-600 mr-2"></i>Advanced Settings</h3>
                    <div class="mb-3">
                        <label class="block text-xs font-bold text-gray-700 mb-1">Plant Search Priority</label>
                        <input type="text" id="plantPriority" placeholder="e.g. WGJ1, WGJ7, WGJ4"
                            class="w-full border p-2 text-sm rounded focus:ring-2 focus:ring-gray-500"
                            onchange="saveSettings()">
                        <p class="text-[10px] text-gray-500 mt-1">Comma-separated list used for matching logic.</p>
                    </div>

                    <div class="mt-4 border-t pt-4">
                        <label class="flex items-center mb-2">
                            <input type="checkbox" id="smartZero" checked class="mr-2">
                            <span class="text-xs font-bold text-blue-800">Enable Smart "Leading Zero" Match (Matches
                                '123' with '000123')</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="useScanQty" checked class="mr-2">
                            <span class="text-xs font-bold text-blue-800">Read "Qty" column from Scan File (Deducts
                                actual quantity)</span>
                        </label>
                        <label class="flex items-center mt-2">
                            <input type="checkbox" id="autoSloc" checked class="mr-2">
                            <span class="text-xs font-bold text-purple-700">Enable Auto S.Loc Allocation (Use
                                DMG1/RT01)</span>
                        </label>
                    </div>
                </div>

                <div class="bg-white p-5 rounded border border-gray-300">
                    <h4 class="text-sm font-bold text-gray-800 mb-3"><i class="fas fa-link mr-1"></i> Serial
                        Concatenation</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="flex items-center mt-4">
                                <input type="checkbox" id="enableConcat" checked class="mr-2">
                                <span class="text-xs font-bold text-gray-700">Enable Batch+Serial Concatenation</span>
                            </label>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Delimiter</label>
                            <select id="concatDelimiter"
                                class="w-full border p-2 text-sm rounded focus:ring-2 focus:ring-blue-500">
                                <option value="">None (ABC123)</option>
                                <option value="-">Hyphen (ABC-123)</option>
                                <option value="_">Underscore (ABC_123)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded border border-gray-300">
                    <h4 class="text-sm font-bold text-gray-800 mb-3"><i class="fas fa-calendar-times mr-1"></i> Expiry
                        Thresholds</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-orange-700 mb-1">Near Expiry (months)</label>
                            <input type="number" id="nearExpiryMonths" value="5" min="1" max="12"
                                class="w-full border p-2 text-sm rounded focus:ring-2 focus:ring-orange-500"
                                onchange="saveExpirySettings()">
                            <p class="text-[10px] text-gray-500 mt-1">Items expiring within this period</p>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-yellow-700 mb-1">Short Expiry (months)</label>
                            <input type="number" id="shortExpiryMonths" value="12" min="6" max="24"
                                class="w-full border p-2 text-sm rounded focus:ring-2 focus:ring-yellow-500"
                                onchange="saveExpirySettings()">
                            <p class="text-[10px] text-gray-500 mt-1">Items expiring between Near and this period</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded border border-gray-300 md:col-span-2">
                    <h4 class="text-sm font-bold text-gray-800 mb-3"><i class="fas fa-comment-dots mr-1"></i> Custom
                        Status Comments</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-green-700 mb-1">Perfect Match</label>
                            <input type="text" id="txtMatch" value="Matched OK"
                                class="w-full border p-2 text-sm rounded focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-yellow-700 mb-1">Batch Only</label>
                            <input type="text" id="txtBatch" value="Batch Match / Serial Diff"
                                class="w-full border p-2 text-sm rounded focus:ring-2 focus:ring-yellow-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-orange-700 mb-1">Material Only</label>
                            <input type="text" id="txtMat" value="Material OK / Batch Diff"
                                class="w-full border p-2 text-sm rounded focus:ring-2 focus:ring-orange-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-red-700 mb-1">Variance</label>
                            <input type="text" id="txtVar" value="Not found in SAP"
                                class="w-full border p-2 text-sm rounded focus:ring-2 focus:ring-red-500">
                        </div>
                    </div>
                </div>

            </div>

            <div class="md:col-span-2 mt-4">
                <button onclick="saveSettings(); alert('Settings Saved Successfully!');"
                    class="w-full bg-gray-800 text-white px-6 py-3 rounded shadow hover:bg-gray-700 font-bold text-sm flex items-center justify-center transition">
                    <i class="fas fa-save mr-2"></i> SAVE ALL SETTINGS
                </button>
            </div>

        </div>
    </div>

    <div id="duplicateWarning"
        class="hidden mb-4 bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded shadow animate-fade">
        <div class="flex items-start">
            <i class="fas fa-exclamation-triangle text-yellow-600 text-xl mr-3 mt-1"></i>
            <div class="flex-1">
                <h4 class="font-bold text-yellow-800 mb-1">Duplicate Serials Detected in SAP Data</h4>
                <p class="text-sm text-yellow-700" id="duplicateMessage"></p>
                <button onclick="showDuplicateDetails()"
                    class="text-xs text-yellow-800 underline mt-2 hover:text-yellow-900">
                    View Details
                </button>
            </div>
            <button onclick="document.getElementById('duplicateWarning').classList.add('hidden')"
                class="text-yellow-600 hover:text-yellow-800">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <div id="errorPanel" class="hidden mb-4 bg-red-50 border-l-4 border-red-500 p-4 rounded shadow animate-fade">
        <div class="flex items-start">
            <i class="fas fa-exclamation-circle text-red-600 text-xl mr-3 mt-1"></i>
            <div class="flex-1">
                <h4 class="font-bold text-red-800 mb-1">Validation Errors</h4>
                <div id="errorList" class="text-sm text-red-700 space-y-1 max-h-40 overflow-y-auto"></div>
                <button onclick="downloadErrorLog()"
                    class="text-xs bg-red-600 text-white px-3 py-1 rounded mt-2 hover:bg-red-700">
                    <i class="fas fa-download mr-1"></i> Download Error Log
                </button>
            </div>
            <button onclick="document.getElementById('errorPanel').classList.add('hidden')"
                class="text-red-600 hover:text-red-800">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <div id="progressContainer" class="hidden mb-4 bg-white p-4 rounded shadow border-l-4 border-blue-600 animate-fade">
        <div class="flex items-center justify-between mb-2">
            <h4 class="font-bold text-gray-800"><i class="fas fa-spinner fa-spin mr-2 text-blue-600"></i>
                Processing...</h4>
            <span id="progressPercent" class="text-sm font-bold text-blue-600">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
            <div id="progressBar"
                class="h-3 rounded-full transition-all duration-300 bg-gradient-to-r from-blue-500 to-purple-600"
                style="width: 0%"></div>
        </div>
        <p id="progressStatus" class="text-xs text-gray-600 mt-2">Initializing...</p>
    </div>

    <div id="statusLog"
        class="hidden mb-4 p-3 bg-gray-900 text-green-400 font-mono text-xs rounded max-h-32 overflow-y-auto"></div>

    <!-- 1. SAP System File (Required Common Step) -->
    <div class="bg-white p-5 rounded shadow border-l-4 border-blue-900 mb-6">
        <label class="block font-bold text-gray-800 mb-1 text-lg">1. Upload SAP System Dump (Required)</label>
        <div class="text-xs text-gray-500 mb-3">Upload your SAP YSRL export file (.xlsx or .csv) to load inventory
            reference.</div>
        <input type="file" id="fileSystem" onchange="loadSystemInventory(this.files[0])"
            class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:bg-blue-50 file:text-blue-900 hover:file:bg-blue-100 cursor-pointer border border-gray-300 rounded p-1" />
    </div>

    <!-- 2. Mode Selection Buttons -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <button onclick="enableBulkMode()"
            class="bg-gray-900 hover:bg-black text-white py-5 rounded font-bold shadow-lg flex items-center justify-center transition uppercase tracking-wider text-sm md:text-base border-b-4 border-gray-700 active:border-b-0 active:translate-y-1">
            START BULK VALIDATION
        </button>
        <button onclick="openLiveScanMode()"
            class="bg-red-700 hover:bg-red-800 text-white py-5 rounded font-bold shadow-lg flex items-center justify-center transition uppercase tracking-wider text-sm md:text-base border-b-4 border-red-900 active:border-b-0 active:translate-y-1">
            <i class="fas fa-barcode mr-2"></i> START LIVE SCANNER
        </button>
    </div>

    <!-- 3. Bulk Inputs (Hidden Area) -->
    <div id="bulkUploadSection" class="hidden animate-fade mb-8">
        <div class="bg-gray-100 p-5 rounded border border-gray-300 mb-4 relative">
            <div
                class="absolute -top-3 left-4 bg-gray-900 text-white text-[10px] px-2 py-1 rounded font-bold uppercase">
                Bulk Mode Active</div>
            <label class="block font-bold text-gray-700 mb-1">2. Upload Scan Data File</label>
            <div class="text-[10px] text-gray-400 mb-2">Upload the Excel/CSV file from your handheld scanner</div>
            <input type="file" id="fileScan"
                class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:bg-gray-200 file:text-gray-800 hover:file:bg-gray-300 cursor-pointer border border-gray-300 rounded p-1 bg-white" />
        </div>

        <button id="btnRun" onclick="runValidation()"
            class="w-full bg-blue-800 hover:bg-blue-900 text-white font-bold py-3 rounded shadow-lg transition active:scale-[0.99]">
            <i class="fas fa-play-circle mr-2"></i> RUN VALIDATION
        </button>
    </div>

    <div id="preValidationModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 rounded-t-lg">
                <h3 class="text-xl font-bold flex items-center">
                    <i class="fas fa-clipboard-check mr-2"></i>
                    Pre-Validation Report
                </h3>
            </div>
            <div class="p-6">
                <div id="preValidationChecks" class="space-y-3 mb-6">
                </div>
                <div class="flex gap-3 justify-end">
                    <button onclick="closePreValidation()"
                        class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded font-bold">
                        Cancel
                    </button>
                    <button id="btnProceed" onclick="proceedWithValidation()"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold">
                        Proceed Anyway
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="duplicateDetailsModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] flex flex-col">
            <div class="bg-yellow-500 text-white p-4 rounded-t-lg flex justify-between items-center">
                <h3 class="text-xl font-bold flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    Duplicate Serials Detected
                </h3>
                <button onclick="document.getElementById('duplicateDetailsModal').classList.add('hidden')"
                    class="text-white hover:text-yellow-100">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 flex-1 overflow-hidden flex flex-col">
                <p class="text-sm text-gray-600 mb-2">The following serials were found multiple times in the SAP System
                    file. You can copy or export this list.</p>
                <textarea id="txtDuplicateDetails" readonly
                    class="w-full flex-1 p-3 border rounded font-mono text-xs bg-gray-50 mb-3 focus:outline-none resize-none h-64"></textarea>
                <div class="flex gap-3 justify-end">
                    <button onclick="copyDuplicateDetails()"
                        class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded font-bold text-sm flex items-center">
                        <i class="fas fa-copy mr-2"></i> Copy to Clipboard
                    </button>
                    <button onclick="exportDuplicateCSV()"
                        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded font-bold text-sm flex items-center">
                        <i class="fas fa-file-csv mr-2"></i> Export CSV
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="colVisModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[70]">
        <div class="bg-white rounded-lg shadow-xl max-w-sm w-full mx-4 flex flex-col max-h-[80vh]">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fas fa-columns text-blue-600 mr-2"></i>Show/Hide Columns</h3>
                <button onclick="document.getElementById('colVisModal').classList.add('hidden')"
                    class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 overflow-y-auto flex-1 space-y-2" id="colVisList">
            </div>
            <div class="p-3 border-t bg-gray-50 text-right">
                <button onclick="document.getElementById('colVisModal').classList.add('hidden')"
                    class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold">Done</button>
            </div>
        </div>
    </div>

    <div id="updatesModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60]">
        <div class="bg-white rounded-lg shadow-2xl max-w-lg w-full mx-4 animate-fade">
            <div
                class="bg-gradient-to-r from-green-500 to-teal-500 text-white p-4 rounded-t-lg flex justify-between items-center">
                <h3 class="text-xl font-bold"><i class="fas fa-bullhorn mr-2"></i>What's New</h3>
                <button onclick="closeUpdates()" class="text-white hover:text-green-100"><i
                        class="fas fa-times"></i></button>
            </div>
            <div class="p-5 max-h-[70vh] overflow-y-auto">
                <div class="space-y-4">
                    <div class="border-l-4 border-green-500 pl-3">
                        <h4 class="font-bold text-gray-800">v2.1 - Table Adjustments</h4>
                        <ul class="list-disc list-inside text-sm text-gray-600 mt-1">
                            <li><b>Column Visibility:</b> You can now show/hide specific columns using the new "Adjust
                                Columns" button.</li>
                            <li><b>Resize Fix:</b> Fixed issue where resizing a column triggered sorting.</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 p-3 rounded-b-lg text-right">
                <button onclick="closeUpdates()"
                    class="bg-green-600 text-white px-4 py-2 rounded font-bold hover:bg-green-700">Awesome!</button>
            </div>
        </div>
    </div>

    <div id="aboutModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60]">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full mx-4 animate-fade flex flex-col max-h-[85vh]">
            <div class="bg-gray-800 text-white p-4 rounded-t-lg flex justify-between items-center">
                <h3 class="text-xl font-bold"><i class="fas fa-info-circle mr-2"></i>About This Tool</h3>
                <button onclick="document.getElementById('aboutModal').classList.add('hidden')"
                    class="text-white hover:text-gray-300"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <h4 class="font-bold text-lg text-purple-700 mb-2">What is this?</h4>
                <p class="text-sm text-gray-600 mb-4">
                    The <b>SAP Inventory Validator</b> is a client-side tool designed to assist Warehouse Management
                    teams in reconciling physical stock counts (scanned via GS1 barcodes) against SAP system dumps.
                </p>

                <h4 class="font-bold text-lg text-blue-700 mb-2">How it Works</h4>
                <p class="text-sm text-gray-600 mb-2">The tool uses a <b>Waterfall Matching Logic</b> to link scanned
                    items with SAP records:</p>
                <ol class="list-decimal list-inside text-sm text-gray-600 space-y-1 mb-4 pl-2">
                    <li><b>Exact Match:</b> Matches Material + Batch + Serial. (Highest Confidence)</li>
                    <li><b>Batch Match:</b> Matches Material + Batch (if Serial differs or is missing).</li>
                    <li><b>Material Match:</b> Matches Material only (if Batch/Serial differ).</li>
                </ol>

                <h4 class="font-bold text-lg text-orange-700 mb-2">Logic & Rules</h4>
                <ul class="list-disc list-inside text-sm text-gray-600 space-y-1 mb-4 pl-2">
                    <li><b>Stock Status:</b> Determined by Expiry Date and "System Condition".</li>
                    <li><b>Customer Lookup:</b> Fetches Customer Name from Master Data based on Customer Code (supports
                        fuzzy string matching).</li>
                    <li><b>Storage Location:</b> Automatically assigned based on Status (Good Stock vs Damage) using
                        your configured codes.</li>
                </ul>

                <div class="bg-yellow-50 p-3 rounded border border-yellow-200 text-xs text-yellow-800">
                    <b>Privacy Note:</b> This tool runs 100% in your browser. No data is uploaded to any server. Your
                    files remain on your device.
                </div>

                <h4 class="font-bold text-lg text-gray-800 mb-2 mt-4"><i class="fas fa-keyboard mr-2"></i>Keyboard
                    Shortcuts</h4>
                <div class="grid grid-cols-2 gap-2 text-sm text-gray-600">
                    <div class="bg-gray-50 p-2 rounded border"><kbd class="bg-white border rounded px-1">Alt</kbd> +
                        <kbd class="bg-white border rounded px-1">F</kbd> Focus Search
                    </div>
                    <div class="bg-gray-50 p-2 rounded border"><kbd class="bg-white border rounded px-1">Ctrl</kbd> +
                        <kbd class="bg-white border rounded px-1">Shift</kbd> + <kbd
                            class="bg-white border rounded px-1">L</kbd> Clear Filters
                    </div>
                    <div class="bg-gray-50 p-2 rounded border"><kbd class="bg-white border rounded px-1">Esc</kbd> Close
                        Panels</div>
                    <div class="bg-gray-50 p-2 rounded border"><kbd class="bg-white border rounded px-1">P</kbd> Pause
                        Live Scan</div>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboard" class="hidden space-y-6">

        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">

            <div class="bg-blue-50 p-3 rounded shadow border-t-4 border-blue-900 relative overflow-hidden">
                <div class="text-blue-900 text-[10px] uppercase font-bold">Total SAP Stock</div>
                <div class="text-2xl font-extrabold text-blue-900" id="kpi-sys-total">0</div>
            </div>

            <div class="bg-white p-3 rounded shadow border-t-4 border-gray-500">
                <div class="text-gray-500 text-[10px] uppercase font-bold">Total Scanned</div>
                <div class="text-2xl font-bold text-gray-800" id="kpi-total">0</div>
                <div class="text-[9px] text-gray-400 mt-1" id="kpi-scan-info"></div>
            </div>

            <div class="bg-white p-3 rounded shadow border-t-4 border-green-500">
                <div class="text-green-600 text-[10px] uppercase font-bold">Serial Match</div>
                <div class="text-2xl font-bold text-green-700" id="kpi-serial">0</div>
            </div>

            <div class="bg-white p-3 rounded shadow border-t-4 border-yellow-500">
                <div class="text-yellow-600 text-[10px] uppercase font-bold">Batch Match</div>
                <div class="text-2xl font-bold text-yellow-700" id="kpi-batch">0</div>
            </div>

            <div class="bg-white p-3 rounded shadow border-t-4 border-orange-500">
                <div class="text-orange-600 text-[10px] uppercase font-bold">Material Only</div>
                <div class="text-2xl font-bold text-orange-700" id="kpi-mat">0</div>
            </div>

            <div class="bg-white p-3 rounded shadow border-t-4 border-red-500">
                <div class="text-red-600 text-[10px] uppercase font-bold">Variance</div>
                <div class="text-2xl font-bold text-red-700" id="kpi-var">0</div>
            </div>

            <div class="bg-purple-50 p-3 rounded shadow border-t-4 border-purple-600 relative overflow-hidden">
                <div class="text-purple-800 text-[10px] uppercase font-bold">Remaining SAP</div>
                <div class="text-3xl font-extrabold text-purple-900" id="kpi-remain">0</div>
            </div>

            <div class="bg-red-50 p-3 rounded shadow border-t-4 border-red-600">
                <div class="text-red-900 text-[10px] uppercase font-bold">ðŸ”´ Damage</div>
                <div class="text-2xl font-extrabold text-red-900" id="kpi-damage">0</div>
            </div>

            <div class="bg-gray-800 p-3 rounded shadow border-t-4 border-black">
                <div class="text-white text-[10px] uppercase font-bold">âš« Expired</div>
                <div class="text-2xl font-extrabold text-white" id="kpi-expired">0</div>
            </div>

            <div class="bg-orange-50 p-3 rounded shadow border-t-4 border-orange-600">
                <div class="text-orange-900 text-[10px] uppercase font-bold">ðŸŸ  Near Expiry</div>
                <div class="text-2xl font-extrabold text-orange-900" id="kpi-near-expiry">0</div>
            </div>

            <div class="bg-yellow-50 p-3 rounded shadow border-t-4 border-yellow-600">
                <div class="text-yellow-900 text-[10px] uppercase font-bold">ðŸŸ¡ Short Expiry</div>
                <div class="text-2xl font-extrabold text-yellow-900" id="kpi-short-expiry">0</div>
            </div>

            <div class="bg-green-50 p-3 rounded shadow border-t-4 border-green-600">
                <div class="text-green-900 text-[10px] uppercase font-bold">ðŸŸ¢ Good Stock</div>
                <div class="text-2xl font-extrabold text-green-900" id="kpi-good-stock">0</div>
            </div>

        </div>

        <div id="summaryStats"
            class="hidden bg-gradient-to-r from-purple-50 to-blue-50 p-5 rounded-lg shadow-md border border-purple-200">
            <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-chart-line text-purple-600 mr-2"></i>
                Validation Summary
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-4 rounded shadow-sm">
                    <div class="text-xs text-gray-500 uppercase font-bold mb-1">Match Rate</div>
                    <div class="text-3xl font-extrabold text-green-600" id="stat-match-rate">0%</div>
                    <div class="text-xs text-gray-400 mt-1" id="stat-match-detail">0 of 0 matched</div>
                </div>
                <div class="bg-white p-4 rounded shadow-sm">
                    <div class="text-xs text-gray-500 uppercase font-bold mb-1">Processing Time</div>
                    <div class="text-3xl font-extrabold text-blue-600" id="stat-process-time">0s</div>
                    <div class="text-xs text-gray-400 mt-1" id="stat-speed">0 items/sec</div>
                </div>
                <div class="bg-white p-4 rounded shadow-sm">
                    <div class="text-xs text-gray-500 uppercase font-bold mb-1">Files Processed</div>
                    <div class="text-lg font-bold text-gray-700" id="stat-files">
                        <div class="text-xs"><i class="fas fa-barcode mr-1"></i> <span id="stat-scan-file">-</span>
                        </div>
                        <div class="text-xs mt-1"><i class="fas fa-database mr-1"></i> <span id="stat-sap-file">-</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4 bg-white p-3 rounded shadow-sm">
                <div class="text-xs text-gray-500 uppercase font-bold mb-2">Top 3 Variance Materials</div>
                <div id="stat-top-variance" class="text-sm text-gray-600">No variance detected</div>
            </div>
        </div>

        <div id="historyPanel"
            class="bg-gradient-to-r from-indigo-50 to-purple-50 p-5 rounded-lg shadow-md border border-indigo-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-gray-800 flex items-center">
                    <i class="fas fa-history text-indigo-600 mr-2"></i>
                    Session History
                </h3>
                <button onclick="clearHistory()" class="text-xs text-red-600 hover:text-red-800 font-bold">
                    <i class="fas fa-trash mr-1"></i> Clear All
                </button>
            </div>
            <div id="historyList" class="space-y-2">
                <div class="text-sm text-gray-500 italic text-center py-4">No validation history yet</div>
            </div>
        </div>

        <!-- ACTIVE FILTERS BAR -->
        <div id="activeFiltersBar"
            class="hidden flex flex-wrap items-center bg-blue-50 border border-blue-200 p-2 rounded shadow-sm animate-fade">
        </div>

        <div
            class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-3 rounded shadow border border-gray-200">
            <div class="relative w-full md:w-1/3">
                <input type="text" id="searchBox" onkeyup="filterData()" placeholder="Search anything..."
                    class="w-full pl-9 pr-4 py-2 border rounded text-sm focus:outline-none focus:border-blue-500">
                <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
            </div>
            <div class="flex gap-2">
                <button onclick="openColVis()"
                    class="bg-blue-50 text-blue-700 border border-blue-200 px-4 py-2 rounded shadow hover:bg-blue-100 font-bold text-sm flex items-center">
                    <i class="fas fa-eye mr-2"></i> Adjust Columns
                </button>
                <button onclick="exportResult()"
                    class="bg-green-600 text-white px-5 py-2 rounded shadow hover:bg-green-700 font-bold text-sm flex items-center">
                    <i class="fas fa-file-excel mr-2"></i> Export Excel
                </button>
            </div>
        </div>


        <div class="bg-gray-800 text-white p-2 mb-2 rounded flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-bolt text-yellow-400"></i>
                <span class="text-sm font-bold">Quick Views:</span>
                <div id="quickExportButtons" class="flex gap-2 ml-2"></div>
            </div>
            <div class="text-xs text-gray-400">Click name to view, Icon to export</div>
        </div>

        <div class="bg-white rounded shadow overflow-hidden border border-gray-200">
            <div class="overflow-x-auto max-h-[600px]">
                <table class="w-full text-sm text-left relative">
                    <thead class="bg-gray-100 text-gray-700 uppercase text-xs sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="px-4 py-3 border-b relative" onclick="sortBy('statusPriority')">Status <i
                                    id="icon-statusPriority" class="fas fa-sort text-gray-400 ml-1"></i>
                                <div class="resizer"></div>
                            </th>
                            <th class="px-4 py-3 border-b relative" onclick="sortBy('logic')">Logic <i id="icon-logic"
                                    class="fas fa-sort text-gray-400 ml-1"></i>
                                <div class="resizer"></div>
                            </th>
                            <th class="px-4 py-3 border-b relative" onclick="sortBy('mat')">Material <i id="icon-mat"
                                    class="fas fa-sort text-gray-400 ml-1"></i>
                                <div class="resizer"></div>
                            </th>
                            <th class="px-4 py-3 border-b relative" onclick="sortBy('desc')">Description <i
                                    id="icon-desc" class="fas fa-sort text-gray-400 ml-1"></i>
                                <div class="resizer"></div>
                            </th>
                            <th class="px-4 py-3 border-b relative" onclick="sortBy('cust')">Customer Name <i
                                    id="icon-cust" class="fas fa-sort text-gray-400 ml-1"></i>
                                <div class="resizer"></div>
                            </th>
                            <th class="px-4 py-3 border-b relative" onclick="sortBy('custCode')">Customer Code <i
                                    id="icon-custCode" class="fas fa-sort text-gray-400 ml-1"></i>
                                <div class="resizer"></div>
                            </th>
                            <th class="px-4 py-3 border-b relative" onclick="sortBy('sysPlant')">Plant <i
                                    id="icon-sysPlant" class="fas fa-sort text-gray-400 ml-1"></i>
                                <div class="resizer"></div>
                            </th>
                            <th class="px-4 py-3 border-b relative" onclick="sortBy('sLoc')">S.Loc <i id="icon-sLoc"
                                    class="fas fa-sort text-gray-400 ml-1"></i>
                                <div class="resizer"></div>
                            </th>
                            <th class="px-4 py-3 th-phy border-l relative" onclick="sortBy('phyBatch')">Phy Batch <i
                                    id="icon-phyBatch" class="fas fa-sort text-gray-400 ml-1"></i>
                                <div class="resizer"></div>
                            </th>
                            <th class="px-4 py-3 th-phy border-r relative" onclick="sortBy('phySer')">Phy Serial <i
                                    id="icon-phySer" class="fas fa-sort text-gray-400 ml-1"></i>
                                <div class="resizer"></div>
                            </th>
                            <th class="px-4 py-3 th-sys relative" onclick="sortBy('sysBatch')">Sys Batch <i
                                    id="icon-sysBatch" class="fas fa-sort text-gray-400 ml-1"></i>
                                <div class="resizer"></div>
                            </th>
                            <th class="px-4 py-3 th-sys border-r relative" onclick="sortBy('sysSer')">Sys Serial <i
                                    id="icon-sysSer" class="fas fa-sort text-gray-400 ml-1"></i>
                                <div class="resizer"></div>
                            </th>
                            <th class="px-4 py-3 border-b relative" onclick="sortBy('condition')">Condition <i
                                    id="icon-condition" class="fas fa-sort text-gray-400 ml-1"></i>
                                <div class="resizer"></div>
                            </th>
                            <th class="px-4 py-3 border-b relative" onclick="sortBy('expiryDate')">Expiry Date <i
                                    id="icon-expiryDate" class="fas fa-sort text-gray-400 ml-1"></i>
                                <div class="resizer"></div>
                            </th>
                            <th class="px-4 py-3 border-b relative" onclick="sortBy('sysExpiry')">Sys Expiry <i
                                    id="icon-sysExpiry" class="fas fa-sort text-gray-400 ml-1"></i>
                                <div class="resizer"></div>
                            </th>
                            <th class="px-4 py-3 border-b relative" onclick="sortBy('daysLeft')">Days Left <i
                                    id="icon-daysLeft" class="fas fa-sort text-gray-400 ml-1"></i>
                                <div class="resizer"></div>
                            </th>
                            <th class="px-4 py-3 border-b relative" onclick="sortBy('stockStatus')">Stock Status <i
                                    id="icon-stockStatus" class="fas fa-sort text-gray-400 ml-1"></i>
                                <div class="resizer"></div>
                            </th>
                            <th class="px-4 py-3 border-b relative" onclick="sortBy('detail')">Comment <i
                                    id="icon-detail" class="fas fa-sort text-gray-400 ml-1"></i>
                                <div class="resizer"></div>
                            </th>
                            <th class="px-4 py-3 border-b relative" onclick="sortBy('raw')">Scan String <i id="icon-raw"
                                    class="fas fa-sort text-gray-400 ml-1"></i>
                                <div class="resizer"></div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <div class="mt-8 mb-8 text-center">
        <div
            class="inline-block px-8 py-3 rounded-full bg-white/40 backdrop-blur-md border border-white/50 shadow-sm hover:shadow-md transition-all duration-300 transform hover:-translate-y-1">
            <p class="text-sm font-extrabold text-slate-700 tracking-wide">Developed by <span
                    class="text-blue-700">Ahemdabad Team</span> <i class="fas fa-code text-blue-400 ml-1"></i></p>
            <div class="h-px bg-slate-300 w-1/2 mx-auto my-2"></div>
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.15em]">Dedicated To Meril-Ahmedabad
                Warehouse</p>
        </div>
    </div>

    </div>

    <script>
        // --- GLOBAL STATE ---
        let globalData = [];
        let displayedData = [];
        let inventoryMap = new Map(); // Added explicit global
        let sortState = { key: '', order: 'asc' };
        let validationErrors = [];
        let duplicateSerials = [];
        let totalSysItemsInitial = 0; // Fixed: Promoted to global scope
        let MATERIAL_MASTER = {}; // { 'code': 'Description' }
        let CUSTOMER_MASTER = {}; // { 'code': 'Customer Name' }
        const CURRENT_VERSION = "2.1";

        // Default Column Visibility
        // Index matches th order in HTML
        const TABLE_COLUMNS = [
            "Status", "Logic", "Material", "Description", "Customer Name", "Customer Code",
            "Plant", "S.Loc", "Phy Batch", "Phy Serial", "Sys Batch", "Sys Serial",
            "Condition", "Expiry Date", "Sys Expiry", "Days Left", "Stock Status", "Comment", "Scan String"
        ];
        // Load hidden cols from storage
        let hiddenColumns = JSON.parse(localStorage.getItem('sapVal_hiddenCols') || '[]');


        // --- INIT ---
        window.onload = function () {
            checkVersion();
            applyColumnVisibility(); // Apply on load
        };

        function checkVersion() {
            const lastVer = localStorage.getItem('sapVal_version');
            if (lastVer !== CURRENT_VERSION) {
                document.getElementById('updatesModal').classList.remove('hidden');
                localStorage.setItem('sapVal_version', CURRENT_VERSION);
            }
        }

        function closeUpdates() {
            document.getElementById('updatesModal').classList.add('hidden');
        }

        function showAbout() {
            document.getElementById('aboutModal').classList.remove('hidden');
        }

        // --- COLUMN VISIBILITY LOGIC ---
        function openColVis() {
            // Get current table headers dynamically
            const headers = Array.from(document.querySelectorAll('thead th')).map(th => {
                // Extract text content, removing sort icon
                const text = th.textContent.trim();
                return text.replace(/[\u00A0\s]+$/, ''); // Remove trailing spaces and icons
            });

            const list = document.getElementById('colVisList');
            list.innerHTML = headers.map((col, index) => {
                const isHidden = hiddenColumns.includes(index);
                return `
                    <label class="flex items-center space-x-3 p-2 hover:bg-gray-50 rounded cursor-pointer border border-transparent hover:border-gray-200">
                        <input type="checkbox" onchange="toggleColumn(${index})" ${!isHidden ? 'checked' : ''} class="w-4 h-4 text-blue-600 rounded">
                        <span class="text-sm font-medium ${isHidden ? 'text-gray-400' : 'text-gray-800'}">${col}</span>
                    </label>
                `;
            }).join('');
            document.getElementById('colVisModal').classList.remove('hidden');
        }

        function toggleColumn(index) {
            if (hiddenColumns.includes(index)) {
                hiddenColumns = hiddenColumns.filter(i => i !== index);
            } else {
                hiddenColumns.push(index);
            }
            localStorage.setItem('sapVal_hiddenCols', JSON.stringify(hiddenColumns));
            applyColumnVisibility();
            // Re-render list to update styles
            openColVis();
        }

        function applyColumnVisibility() {
            const styleTag = document.getElementById('columnVisibilityStyles');
            if (hiddenColumns.length === 0) {
                styleTag.innerHTML = "";
                return;
            }
            // Generate CSS to hide specific nth-child
            // nth-child is 1-based
            const rules = hiddenColumns.map(i => {
                const n = i + 1;
                return `#tableBody tr td:nth-child(${n}), thead th:nth-child(${n}) { display: none; }`;
            }).join('\n');
            styleTag.innerHTML = rules;
        }


        // --- UTILS ---
        function toggleSettingsPage() {
            const settings = document.getElementById('settingsPage');
            const dashboard = document.getElementById('dashboard');
            const landing = document.getElementById('preValidationModal').parentNode.querySelector('.w-full.max-w-\\[99\\%\\]'); // Main container
            const runBtn = document.getElementById('btnRun');
            const fileInputs = document.getElementById('btnRun').previousElementSibling; // The div containing file inputs

            if (settings.classList.contains('hidden')) {
                // Show Settings
                settings.classList.remove('hidden');
                // Hide other main elements safely
                document.querySelectorAll('.w-full.max-w-\\[99\\%\\] > div:not(#settingsPage):not(header)').forEach(el => el.classList.add('hidden'));
                runBtn.classList.add('hidden');
            } else {
                // Hide Settings
                settings.classList.add('hidden');
                // Restore main elements
                document.querySelectorAll('.w-full.max-w-\\[99\\%\\] > div:not(#settingsPage):not(header)').forEach(el => {
                    if (el.id !== 'dashboard' && el.id !== 'errorPanel' && el.id !== 'duplicateWarning' && el.id !== 'progressContainer' && el.id !== 'statusLog' && el.id !== 'summaryStats') {
                        el.classList.remove('hidden');
                    }
                });

                // Only show dashboard if we have data
                if (displayedData.length > 0) document.getElementById('dashboard').classList.remove('hidden');

                runBtn.classList.remove('hidden');
            }
        }

        async function loadCustomerData() {
            const f = document.getElementById('fileCustomer').files[0];
            if (!f) return;
            try {
                const data = await readXlsx(f);
                if (data.length < 2) throw new Error("File too short"); // Need header + data
                // Look for header row (e.g. Row 0 or 1)
                // We'll just assume Row 1 (index 1) has data if Row 0 is header
                // Or just try to find "Customer" key in Row 0
                const headers = data[0].map(x => String(x).toLowerCase());
                const iCust = headers.findIndex(h => h.includes('customer') || h.includes('name'));
                const iProj = headers.findIndex(h => h.includes('project') || h.includes('site') || h.includes('location'));

                if ((iCust > -1 || iProj > -1) && data.length > 1) {
                    const row = data[1]; // Take first data row
                    if (iCust > -1) document.getElementById('custName').value = row[iCust] || '';
                    if (iProj > -1) document.getElementById('custProject').value = row[iProj] || '';
                    saveSettings(); // Auto-save
                    alert("Customer data loaded!");
                } else {
                    throw new Error("Could not find Customer/Project columns in Row 1");
                }
            } catch (e) {
                alert("Customer Data Error: " + e.message);
            }
        }

        async function loadMasterData() {
            const f = document.getElementById('fileMaster').files[0];
            if (!f) return;

            try {
                const data = await readXlsx(f);
                if (data.length < 1) throw new Error("Empty file");

                // Find headers
                const headers = data[0].map(x => String(x).toLowerCase());
                const iMat = headers.findIndex(h => h.includes('material') || h.includes('code') || h.includes('item') || h.includes('part') || h.includes('product') || h.includes('sku'));
                const iDesc = headers.findIndex(h => h.includes('desc') || h.includes('name') || h.includes('text') || h.includes('detail') || h.includes('spec') || h.includes('title'));

                if (iMat === -1 || iDesc === -1) throw new Error("Could not find 'Material' and 'Description' columns.");

                let count = 0;
                MATERIAL_MASTER = {};
                const listEl = document.getElementById('masterList');
                listEl.innerHTML = "";

                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    if (row[iMat]) {
                        const m = clean(row[iMat]);
                        const d = String(row[iDesc] || '').trim();
                        MATERIAL_MASTER[m] = d;
                        count++;
                        if (count <= 10) {
                            listEl.innerHTML += `<li class="truncate"><b>${m}</b>: ${d}</li>`;
                        }
                    }
                }
                if (count > 10) listEl.innerHTML += `<li class="italic text-gray-400">...and ${count - 10} more</li>`;
                document.getElementById('masterCount').innerText = count;

                // SAVE TO LOCAL STORAGE
                saveSettings();
                saveToDB('materialMaster', MATERIAL_MASTER);

                alert(`Successfully loaded ${count} materials.`);

            } catch (e) {
                alert("Master Data Error: " + e.message);
            }
        }

        async function loadCustomerMasterData() {
            const f = document.getElementById('fileCustomerMaster').files[0];
            if (!f) return;

            try {
                const data = await readXlsx(f);
                if (data.length < 1) throw new Error("Empty file");

                // Find headers
                const headers = data[0].map(x => String(x).toLowerCase());
                const iCode = headers.findIndex(h => h.includes('code') || h.includes('id') || h.includes('no') || h.includes('customer'));
                const iName = headers.findIndex(h => h.includes('name') || h.includes('desc') || h.includes('customer'));

                // Basic validation strictly for Code and Name columns if they are distinct
                // If "Customer" matches both, we might have issues, so let's refine:
                // iCode: prefer 'code', 'id', 'no'
                // iName: prefer 'name', 'text'

                if (iCode === -1 || iName === -1) throw new Error("Could not find 'Customer Code' and 'Customer Name' columns.");

                let count = 0;
                CUSTOMER_MASTER = {};
                const listEl = document.getElementById('custMasterList');
                listEl.innerHTML = "";

                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    if (row[iCode]) {
                        const c = clean(row[iCode]);
                        const n = String(row[iName] || '').trim();
                        if (c && n) {
                            CUSTOMER_MASTER[c] = n;

                            // Alias for numeric mismatch (e.g. '00123' -> '123')
                            // If Code is numeric, store the number version too
                            if (!isNaN(parseFloat(c))) {
                                const numC = String(parseFloat(c));
                                if (numC !== c) {
                                    CUSTOMER_MASTER[numC] = n;
                                }
                            }

                            count++;
                            if (count <= 10) {
                                listEl.innerHTML += `<li class="truncate"><b>${c}</b>: ${n}</li>`;
                            }
                        }
                    }
                }
                if (count > 10) listEl.innerHTML += `<li class="italic text-gray-400">...and ${count - 10} more</li>`;
                document.getElementById('custMasterCount').innerText = count;

                // SAVE TO LOCAL STORAGE
                saveSettings();
                saveToDB('customerMaster', CUSTOMER_MASTER);

                alert(`Successfully loaded ${count} customers.`);

            } catch (e) {
                alert("Customer Master Error: " + e.message);
            }
        }

        // --- PERSISTENCE (IndexedDB + LocalStorage) ---
        let db;
        const initDB = () => {
            const req = indexedDB.open("ValToolDB", 1);
            req.onupgradeneeded = e => e.target.result.createObjectStore("store");
            req.onsuccess = e => {
                db = e.target.result;
                loadFromDB("materialMaster", v => {
                    if (v) { MATERIAL_MASTER = v; updateMasterList(v, 'masterList', 'masterCount'); }
                });
                loadFromDB("customerMaster", v => {
                    if (v) { CUSTOMER_MASTER = v; updateMasterList(v, 'custMasterList', 'custMasterCount'); }
                });
            };
        };
        const saveToDB = (k, v) => {
            if (db) db.transaction(["store"], "readwrite").objectStore("store").put(v, k);
        };
        const loadFromDB = (k, cb) => {
            if (db) db.transaction(["store"]).objectStore("store").get(k).onsuccess = e => cb(e.target.result);
        };
        const updateMasterList = (data, listId, countId) => {
            const list = document.getElementById(listId);
            list.innerHTML = "";
            let c = 0;
            for (let k in data) {
                if (c++ < 10) list.innerHTML += `<li class="truncate"><b>${k}</b>: ${data[k]}</li>`;
            }
            if (c > 10) list.innerHTML += `<li class="italic text-gray-400">...and ${c - 10} more</li>`;
            document.getElementById(countId).innerText = c + " (cached)";
        };

        function saveSettings() {
            const settings = {
                custName: document.getElementById('custName').value,
                custProject: document.getElementById('custProject').value,
                aiMaterial: document.getElementById('aiMaterial').value,
                aiBatch: document.getElementById('aiBatch').value,
                aiSerial: document.getElementById('aiSerial').value,
                enableConcat: document.getElementById('enableConcat').checked,
                concatDelimiter: document.getElementById('concatDelimiter').value,
                nearExpiryMonths: document.getElementById('nearExpiryMonths').value,
                shortExpiryMonths: document.getElementById('shortExpiryMonths').value,
                txtMatch: document.getElementById('txtMatch').value,
                txtBatch: document.getElementById('txtBatch').value,
                txtMat: document.getElementById('txtMat').value,
                txtVar: document.getElementById('txtVar').value,
                exportLayout: document.getElementById('exportLayout').value,
                plantPriority: document.getElementById('plantPriority').value,
                goodSloc: document.getElementById('txtGoodSloc').value,
                dmgSloc: document.getElementById('txtDmgSloc').value,
                // --- [UPDATED LOGIC] ---
                smartZero: document.getElementById('smartZero').checked,
                useScanQty: document.getElementById('useScanQty').checked,
                autoSloc: document.getElementById('autoSloc').checked
            };
            try {
                localStorage.setItem('sapVal_settings_v12', JSON.stringify(settings));
                // Optional: visual feedback?
            } catch (e) {
                console.warn("Storage quota exceeded or error", e);
            }
        }

        function loadSettings() {
            try {
                const raw = localStorage.getItem('sapVal_settings_v12');
                if (!raw) return;
                const s = JSON.parse(raw);

                if (s.custName) document.getElementById('custName').value = s.custName;
                if (s.custProject) document.getElementById('custProject').value = s.custProject;
                if (s.aiMaterial) document.getElementById('aiMaterial').value = s.aiMaterial;
                if (s.aiBatch) document.getElementById('aiBatch').value = s.aiBatch;
                if (s.aiSerial) document.getElementById('aiSerial').value = s.aiSerial;

                if (s.enableConcat !== undefined) document.getElementById('enableConcat').checked = s.enableConcat;
                if (s.concatDelimiter) document.getElementById('concatDelimiter').value = s.concatDelimiter;

                if (s.nearExpiryMonths) document.getElementById('nearExpiryMonths').value = s.nearExpiryMonths;
                if (s.shortExpiryMonths) document.getElementById('shortExpiryMonths').value = s.shortExpiryMonths;

                if (s.txtMatch) document.getElementById('txtMatch').value = s.txtMatch;
                if (s.txtBatch) document.getElementById('txtBatch').value = s.txtBatch;
                if (s.txtMat) document.getElementById('txtMat').value = s.txtMat;
                if (s.txtVar) document.getElementById('txtVar').value = s.txtVar;

                // V13 Enhancements
                if (s.plantPriority) document.getElementById('plantPriority').value = s.plantPriority;

                // Storage Location Settings
                if (s.goodSloc) document.getElementById('txtGoodSloc').value = s.goodSloc;
                if (s.dmgSloc) document.getElementById('txtDmgSloc').value = s.dmgSloc;

                // --- [UPDATED LOGIC] ---
                if (s.smartZero !== undefined) document.getElementById('smartZero').checked = s.smartZero;
                if (s.useScanQty !== undefined) document.getElementById('useScanQty').checked = s.useScanQty;
                if (s.autoSloc !== undefined) document.getElementById('autoSloc').checked = s.autoSloc;
                // ---

                if (s.exportLayout) {
                    document.getElementById('exportLayout').value = s.exportLayout;
                } else {
                    // Default Layout
                    document.getElementById('exportLayout').value = "Status, Logic, Material, Description, Customer, P_ID, S.Loc, Plant, Phy Batch, Phy Serial, Sys Batch, Sys Serial, Condition, Expiry Date, Sys Expiry, Days Left, Stock Status, Comment";
                }

                if (s.materialMaster && Object.keys(s.materialMaster).length > 0) {
                    MATERIAL_MASTER = s.materialMaster;
                    const count = Object.keys(MATERIAL_MASTER).length;
                    const listEl = document.getElementById('masterList');
                    listEl.innerHTML = "";
                    let shown = 0;
                    for (let k in MATERIAL_MASTER) {
                        if (shown < 10) listEl.innerHTML += `<li class="truncate"><b>${k}</b>: ${MATERIAL_MASTER[k]}</li>`;
                        shown++;
                    }
                    if (count > 10) listEl.innerHTML += `<li class="italic text-gray-400">...and ${count - 10} more</li>`;
                    document.getElementById('masterCount').innerText = `${count} (cached)`;
                }

                if (s.customerMaster && Object.keys(s.customerMaster).length > 0) {
                    CUSTOMER_MASTER = s.customerMaster;
                    const count = Object.keys(CUSTOMER_MASTER).length;
                    const listEl = document.getElementById('custMasterList');
                    listEl.innerHTML = "";
                    let shown = 0;
                    for (let k in CUSTOMER_MASTER) {
                        if (shown < 10) listEl.innerHTML += `<li class="truncate"><b>${k}</b>: ${CUSTOMER_MASTER[k]}</li>`;
                        shown++;
                    }
                    if (count > 10) listEl.innerHTML += `<li class="italic text-gray-400">...and ${count - 10} more</li>`;
                    document.getElementById('custMasterCount').innerText = `${count} (cached)`;
                }

            } catch (e) {
                console.error("Error loading settings", e);
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', loadSettings);

        const log = (msg) => {
            const el = document.getElementById('statusLog');
            el.classList.remove('hidden');
            el.innerHTML += `> ${msg}<br>`;
            el.scrollTop = el.scrollHeight;
        };
        // Helper to clean strings (now preserves 0)
        const clean = (val) => String(val !== null && val !== undefined ? val : '').trim().toUpperCase();

        const addError = (row, message, severity = 'error') => {
            validationErrors.push({ row, message, severity });
        };

        const showErrorPanel = () => {
            if (validationErrors.length === 0) return;
            const panel = document.getElementById('errorPanel');
            const list = document.getElementById('errorList');

            const errorHtml = validationErrors.map(e => {
                const icon = e.severity === 'warning' ? 'fa-exclamation-triangle text-yellow-600' : 'fa-times-circle text-red-600';
                return `<div class="flex items-start"><i class="fas ${icon} mr-2 mt-0.5"></i><span><strong>Row ${e.row}:</strong> ${e.message}</span></div>`;
            }).join('');

            list.innerHTML = errorHtml;
            panel.classList.remove('hidden');
        };

        const downloadErrorLog = () => {
            const csv = 'Row,Severity,Message\n' + validationErrors.map(e =>
                `${e.row},${e.severity},"${e.message}"`
            ).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'validation_errors.csv';
            a.click();
        };

        const showDuplicateDetails = () => {
            if (duplicateSerials.length === 0) return;
            const lines = duplicateSerials.map(d =>
                `${d.mat}\t${d.batch}\t${d.ser}\t(Count: ${d.count})`
            ).join('\n');

            document.getElementById('txtDuplicateDetails').value =
                "Material\tBatch\tSerial\tCount\n" + lines;

            document.getElementById('duplicateDetailsModal').classList.remove('hidden');
        };

        const copyDuplicateDetails = () => {
            const txt = document.getElementById('txtDuplicateDetails');
            txt.select();
            document.execCommand('copy'); // Fallback for older browsers
            // Modern way: navigator.clipboard.writeText(txt.value);
            alert("Copied to clipboard!");
        };

        const exportDuplicateCSV = () => {
            if (duplicateSerials.length === 0) return;
            let csv = "Material,Batch,Serial,Count\n";
            duplicateSerials.forEach(d => {
                csv += `"${d.mat}","${d.batch}","${d.ser}",${d.count}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'duplicate_serials_report.csv';
            a.click();
        };

        // --- PROGRESS TRACKING ---
        const updateProgress = (percent, status) => {
            const container = document.getElementById('progressContainer');
            const bar = document.getElementById('progressBar');
            const percentText = document.getElementById('progressPercent');
            const statusText = document.getElementById('progressStatus');

            container.classList.remove('hidden');
            bar.style.width = percent + '%';
            percentText.innerText = Math.round(percent) + '%';
            statusText.innerText = status;
        };

        const hideProgress = () => {
            document.getElementById('progressContainer').classList.add('hidden');
        };

        // --- SUMMARY STATISTICS ---
        const updateSummaryStats = (stats, totalScans, processingTime, scanFileName, sapFileName) => {
            const summaryPanel = document.getElementById('summaryStats');

            // Calculate match rate
            const matched = stats.s + stats.b + stats.m;
            const matchRate = totalScans > 0 ? ((matched / totalScans) * 100).toFixed(1) : 0;

            document.getElementById('stat-match-rate').innerText = matchRate + '%';
            document.getElementById('stat-match-detail').innerText = `${matched} of ${totalScans} matched`;

            // Processing time
            const timeInSec = (processingTime / 1000).toFixed(2);
            document.getElementById('stat-process-time').innerText = timeInSec + 's';

            // Speed
            const speed = processingTime > 0 ? Math.round(totalScans / (processingTime / 1000)) : 0;
            document.getElementById('stat-speed').innerText = speed + ' items/sec';

            // File names
            document.getElementById('stat-scan-file').innerText = scanFileName || '-';
            document.getElementById('stat-sap-file').innerText = sapFileName || '-';

            // Top 3 variance materials
            const varianceMaterials = {};
            globalData.forEach(row => {
                if (row.status === 'Variance' || row.status === 'Error') {
                    varianceMaterials[row.mat] = (varianceMaterials[row.mat] || 0) + 1;
                }
            });

            const topVariance = Object.entries(varianceMaterials)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);

            if (topVariance.length > 0) {
                const varianceHtml = topVariance.map(([mat, count]) =>
                    `<div class="flex justify-between items-center py-1 border-b border-gray-100">
                        <span class="font-mono text-xs">${mat}</span>
                        <span class="bg-red-100 text-red-700 px-2 py-0.5 rounded text-xs font-bold">${count} items</span>
                    </div>`
                ).join('');
                document.getElementById('stat-top-variance').innerHTML = varianceHtml;
            } else {
                document.getElementById('stat-top-variance').innerText = 'No variance detected âœ“';
            }

            summaryPanel.classList.remove('hidden');
        };

        // --- PRE-VALIDATION ---
        let preValidationPassed = false;

        const validateFileExtension = (file) => {
            const validExtensions = ['.xlsx', '.xls'];
            const fileName = file.name.toLowerCase();
            return validExtensions.some(ext => fileName.endsWith(ext));
        };

        const preValidateFiles = async (scanFile, sapFile) => {
            const checks = [];
            let allPassed = true;

            // Check 1: Scan file extension
            const scanExtValid = validateFileExtension(scanFile);
            checks.push({
                name: 'Scan File Extension',
                passed: scanExtValid,
                message: scanExtValid ? `Valid format: ${scanFile.name}` : `Invalid format: ${scanFile.name}. Expected .xlsx or .xls`
            });
            if (!scanExtValid) allPassed = false;

            // Check 2: SAP file extension
            const sapExtValid = validateFileExtension(sapFile);
            checks.push({
                name: 'SAP File Extension',
                passed: sapExtValid,
                message: sapExtValid ? `Valid format: ${sapFile.name}` : `Invalid format: ${sapFile.name}. Expected .xlsx or .xls`
            });
            if (!sapExtValid) allPassed = false;

            // Check 3: Read SAP file and validate columns
            try {
                const sapData = await readXlsx(sapFile);

                // Allow flexible header names for Material (Enhanced)
                const validMatTerms = ['material', 'mat', 'matnr', 'article', 'product', 'item', 'sku', 'part', 'code', 'model', 'identifier'];

                let headerRow = sapData.findIndex(row => {
                    const rowStr = row.join(" ").toLowerCase();
                    return validMatTerms.some(term => rowStr.includes(term));
                });

                // Fallback: search for Batch+Serial if Material not found
                if (headerRow === -1) {
                    headerRow = sapData.findIndex(row => {
                        const s = row.join(" ").toLowerCase();
                        return (s.includes('batch') || s.includes('lot')) && (s.includes('serial') || s.includes('sno'));
                    });
                }

                if (headerRow === -1) {
                    checks.push({
                        name: 'SAP File Columns',
                        passed: false,
                        message: 'Missing required "Material" column header (Checked for: Material, Matnr, Part, Batch+Serial, etc.)'
                    });
                    allPassed = false;
                } else {
                    const headers = sapData[headerRow].map(h => String(h).toLowerCase());
                    let hasMaterial = headers.some(h => validMatTerms.some(term => h.includes(term)));
                    if (headerRow > -1 && !hasMaterial) hasMaterial = true;
                    const hasBatch = headers.some(h => h.includes("batch") || h.includes("lot"));
                    const hasSerial = headers.some(h => h.includes("serial") || h.includes("sno"));

                    if (hasMaterial && hasBatch && hasSerial) {
                        checks.push({
                            name: 'SAP File Columns',
                            passed: true,
                            message: 'All required columns found (Material, Batch, Serial)'
                        });
                    } else {
                        const missing = [];
                        if (!hasMaterial) missing.push('Material');
                        if (!hasBatch) missing.push('Batch');
                        if (!hasSerial) missing.push('Serial');
                        checks.push({
                            name: 'SAP File Columns',
                            passed: false,
                            message: `Missing columns: ${missing.join(', ')}`
                        });
                        allPassed = false;
                    }
                }
            } catch (e) {
                checks.push({
                    name: 'SAP File Readable',
                    passed: false,
                    message: `Error reading file: ${e.message}`
                });
                allPassed = false;
            }

            // Check 4: Read scan file
            try {
                const scanData = await readXlsx(scanFile);
                if (scanData.length === 0) {
                    checks.push({
                        name: 'Scan File Data',
                        passed: false,
                        message: 'Scan file is empty'
                    });
                    allPassed = false;
                } else {
                    checks.push({
                        name: 'Scan File Data',
                        passed: true,
                        message: `Found ${scanData.length} rows`
                    });
                }
            } catch (e) {
                checks.push({
                    name: 'Scan File Readable',
                    passed: false,
                    message: `Error reading file: ${e.message}`
                });
                allPassed = false;
            }

            return { checks, allPassed };
        };

        const showPreValidationReport = (checks, allPassed) => {
            const checksContainer = document.getElementById('preValidationChecks');
            const modal = document.getElementById('preValidationModal');
            const proceedBtn = document.getElementById('btnProceed');

            const checksHtml = checks.map(check => {
                const icon = check.passed ?
                    '<i class="fas fa-check-circle text-green-600"></i>' :
                    '<i class="fas fa-times-circle text-red-600"></i>';
                const bgColor = check.passed ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';

                return `
                    <div class="${bgColor} border-l-4 p-3 rounded">
                        <div class="flex items-start gap-2">
                            <div class="text-xl">${icon}</div>
                            <div class="flex-1">
                                <div class="font-bold text-sm">${check.name}</div>
                                <div class="text-xs text-gray-600 mt-1">${check.message}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            checksContainer.innerHTML = checksHtml;

            if (allPassed) {
                proceedBtn.innerHTML = '<i class="fas fa-play mr-2"></i> Start Validation';
                proceedBtn.className = 'px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded font-bold';
            } else {
                proceedBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i> Proceed Anyway';
                proceedBtn.className = 'px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded font-bold';
            }

            modal.classList.remove('hidden');
        };

        const closePreValidation = () => {
            document.getElementById('preValidationModal').classList.add('hidden');
            preValidationPassed = false;
            const btn = document.getElementById('btnRun');
            btn.innerHTML = 'START VALIDATION';
            btn.disabled = false;
        };

        const proceedWithValidation = () => {
            preValidationPassed = true;
            document.getElementById('preValidationModal').classList.add('hidden');
            actualValidation();
        };

        // --- SESSION HISTORY ---
        const saveToHistory = (validationData) => {
            try {
                let history = JSON.parse(localStorage.getItem('validationHistory') || '[]');
                history.unshift({
                    id: Date.now(),
                    timestamp: new Date().toLocaleString(),
                    scanFile: validationData.scanFile,
                    sapFile: validationData.sapFile,
                    totalScanned: validationData.totalScanned,
                    matched: validationData.matched,
                    matchRate: validationData.matchRate,
                    processingTime: validationData.processingTime,
                    data: validationData.data.slice(0, 1000) // Limit to 1000 rows for storage
                });
                history = history.slice(0, 5); // Keep last 5
                localStorage.setItem('validationHistory', JSON.stringify(history));
                loadHistory();
            } catch (e) {
                console.error('Failed to save history:', e);
            }
        };

        const loadHistory = () => {
            try {
                const history = JSON.parse(localStorage.getItem('validationHistory') || '[]');
                const historyList = document.getElementById('historyList');

                if (history.length === 0) {
                    historyList.innerHTML = '<div class="text-sm text-gray-500 italic text-center py-4">No validation history yet</div>';
                    return;
                }

                const historyHtml = history.map((item, index) => {
                    const matchRateColor = parseFloat(item.matchRate) >= 90 ? 'text-green-600' :
                        parseFloat(item.matchRate) >= 70 ? 'text-yellow-600' : 'text-red-600';

                    return `
                        <div class="bg-white p-3 rounded shadow-sm border border-indigo-100 hover:border-indigo-300 transition">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="text-xs text-gray-500 mb-1">
                                        <i class="fas fa-clock mr-1"></i> ${item.timestamp}
                                    </div>
                                    <div class="text-xs font-mono text-gray-700">
                                        <i class="fas fa-barcode mr-1"></i> ${item.scanFile}
                                    </div>
                                    <div class="flex items-center gap-3 mt-2">
                                        <span class="text-xs"><strong>${item.totalScanned}</strong> scanned</span>
                                        <span class="text-xs ${matchRateColor} font-bold">${item.matchRate}% match</span>
                                        <span class="text-xs text-gray-500">${item.processingTime}</span>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="loadFromHistory(${item.id})" 
                                        class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-xs font-bold"
                                        title="Reload this validation">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                    <button onclick="deleteHistoryItem(${item.id})" 
                                        class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-xs font-bold"
                                        title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                historyList.innerHTML = historyHtml;
            } catch (e) {
                console.error('Failed to load history:', e);
            }
        };

        const loadFromHistory = (id) => {
            try {
                const history = JSON.parse(localStorage.getItem('validationHistory') || '[]');
                const item = history.find(h => h.id === id);

                if (!item) {
                    alert('History item not found');
                    return;
                }

                // Restore global data
                globalData = item.data;
                displayedData = [...globalData];

                // Show dashboard
                document.getElementById('dashboard').classList.remove('hidden');

                // Update KPIs (approximate from stored data)
                const stats = {
                    tot: item.totalScanned,
                    s: globalData.filter(r => r.status === 'Matched').length,
                    b: globalData.filter(r => r.status === 'Partial').length,
                    m: globalData.filter(r => r.status === 'Warning').length,
                    v: globalData.filter(r => r.status === 'Variance' || r.status === 'Error').length
                };

                document.getElementById('kpi-total').innerText = stats.tot;
                document.getElementById('kpi-serial').innerText = stats.s;
                document.getElementById('kpi-batch').innerText = stats.b;
                document.getElementById('kpi-mat').innerText = stats.m;
                document.getElementById('kpi-var').innerText = stats.v;

                // Render table
                sortBy('statusPriority');

                // Show loaded indicator
                const btn = document.getElementById('btnRun');
                btn.innerHTML = '<i class="fas fa-history mr-2"></i> LOADED FROM HISTORY';

                alert(`Loaded validation from ${item.timestamp}`);
            } catch (e) {
                alert('Failed to load history: ' + e.message);
            }
        };

        const deleteHistoryItem = (id) => {
            if (!confirm('Delete this history item?')) return;

            try {
                let history = JSON.parse(localStorage.getItem('validationHistory') || '[]');
                history = history.filter(h => h.id !== id);
                localStorage.setItem('validationHistory', JSON.stringify(history));
                loadHistory();
            } catch (e) {
                alert('Failed to delete history: ' + e.message);
            }
        };

        const clearHistory = () => {
            if (!confirm('Clear all validation history?')) return;

            try {
                localStorage.removeItem('validationHistory');
                loadHistory();
            } catch (e) {
                alert('Failed to clear history: ' + e.message);
            }
        };

        // Load history on page load
        window.addEventListener('DOMContentLoaded', loadHistory);

        // --- EXPIRY SETTINGS ---
        const saveExpirySettings = () => {
            try {
                const settings = {
                    nearExpiryMonths: parseInt(document.getElementById('nearExpiryMonths').value) || 5,
                    shortExpiryMonths: parseInt(document.getElementById('shortExpiryMonths').value) || 12
                };
                localStorage.setItem('expirySettings', JSON.stringify(settings));
                log(`Expiry settings saved: Near=${settings.nearExpiryMonths}mo, Short=${settings.shortExpiryMonths}mo`);
            } catch (e) {
                console.error('Failed to save expiry settings:', e);
            }
        };

        const loadExpirySettings = () => {
            try {
                const settings = JSON.parse(localStorage.getItem('expirySettings') || '{"nearExpiryMonths":5,"shortExpiryMonths":12}');
                document.getElementById('nearExpiryMonths').value = settings.nearExpiryMonths;
                document.getElementById('shortExpiryMonths').value = settings.shortExpiryMonths;
                return settings;
            } catch (e) {
                console.error('Failed to load expiry settings:', e);
                return { nearExpiryMonths: 5, shortExpiryMonths: 12 };
            }
        };

        // Load expiry settings on page load
        window.addEventListener('DOMContentLoaded', loadExpirySettings);

        // --- GS1 EXPIRY PARSER ---
        const parseGS1Expiry = (barcode) => {
            if (!barcode) return null;

            // Extract (17)YYMMDD from barcode
            const expiryMatch = barcode.match(/\(17\)(\d{6})/);
            if (!expiryMatch) return null;

            const yymmdd = expiryMatch[1];
            const yy = parseInt(yymmdd.substring(0, 2));
            const mm = parseInt(yymmdd.substring(2, 4));
            const dd = parseInt(yymmdd.substring(4, 6));

            // Assume 20xx for years (2000-2099)
            const year = 2000 + yy;

            // Validate month and day
            if (mm < 1 || mm > 12 || dd < 1 || dd > 31) {
                console.warn(`Invalid expiry date in barcode: ${yymmdd}`);
                return null;
            }

            // Create date object (month is 0-indexed in JavaScript)
            const expiryDate = new Date(year, mm - 1, dd);

            return expiryDate;
        };

        // --- STATUS CLASSIFICATION ---
        const classifyMaterialStatus = (condition, expiryDate, settings) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to midnight for accurate comparison

            // Priority 1: DAMAGE (highest priority)
            if (condition && condition.toLowerCase().trim() === 'damage') {
                return {
                    status: 'DAMAGE',
                    css: 'bg-red-100 text-red-900 border-red-300',
                    icon: 'ðŸ”´',
                    priority: 1,
                    daysLeft: null
                };
            }

            // No expiry data
            if (!expiryDate) {
                return {
                    status: 'NO EXPIRY',
                    css: 'bg-gray-100 text-gray-600',
                    icon: 'âšª',
                    priority: 6,
                    daysLeft: null
                };
            }

            // Calculate days to expiry
            const daysLeft = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
            const monthsLeft = daysLeft / 30; // Approximate months

            // Priority 2: EXPIRED
            if (daysLeft < 0) {
                return {
                    status: 'EXPIRED',
                    css: 'bg-gray-800 text-white border-gray-900',
                    icon: 'âš«',
                    priority: 2,
                    daysLeft: daysLeft
                };
            }

            // Priority 3: NEAR EXPIRY (0 to nearExpiryMonths)
            if (monthsLeft <= settings.nearExpiryMonths) {
                return {
                    status: 'NEAR EXPIRY',
                    css: 'bg-orange-100 text-orange-900 border-orange-300',
                    icon: 'ðŸŸ ',
                    priority: 3,
                    daysLeft: daysLeft
                };
            }

            // Priority 4: SHORT EXPIRY (nearExpiryMonths to shortExpiryMonths)
            if (monthsLeft <= settings.shortExpiryMonths) {
                return {
                    status: 'SHORT EXPIRY',
                    css: 'bg-yellow-100 text-yellow-900 border-yellow-300',
                    icon: 'ðŸŸ¡',
                    priority: 4,
                    daysLeft: daysLeft
                };
            }

            // Priority 5: GOOD STOCK (>shortExpiryMonths)
            return {
                status: 'GOOD STOCK',
                css: 'bg-green-100 text-green-900 border-green-300',
                icon: 'ðŸŸ¢',
                priority: 5,
                daysLeft: daysLeft
            };
        };

        // --- EXCEL ---
        const readXlsx = (file) => {
            if (file && file.isMock) return Promise.resolve(file.data);

            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        resolve(XLSX.utils.sheet_to_json(ws, { header: 1, defval: "", raw: false }));
                    } catch (err) { reject(err); }
                };
                reader.readAsArrayBuffer(file);
            });
        };

        // --- ENHANCED GS1 PARSER ---
        const parseGS1 = (raw, rowNum = 0) => {
            let s = clean(raw).replace(/[\u0000-\u001F\u007F-\u009F]/g, "");
            let res = { mat: "", batch: "", ser: "", isDefaultSer: false, isValid: true, error: "" };

            // Get AI codes from settings
            const aiMat = document.getElementById('aiMaterial')?.value || '240';
            const aiBatch = document.getElementById('aiBatch')?.value || '10';
            const aiSer = document.getElementById('aiSerial')?.value || '21';

            // Validate GS1 format
            if (!s.includes('(')) {
                res.isValid = false;
                res.error = 'Invalid GS1 format: No AI codes found';
                addError(rowNum, `Invalid GS1 barcode: "${raw.substring(0, 50)}..."`, 'error');
                return res;
            }

            // Extract Material
            const matRegex = new RegExp(`\\(${aiMat}\\)([^()]+)`);
            let m = s.match(matRegex);
            if (m) {
                res.mat = clean(m[1]);
            } else {
                res.isValid = false;
                res.error = `Missing Material AI (${aiMat})`;
                addError(rowNum, `Missing Material code (${aiMat}) in barcode`, 'warning');
            }

            // Extract Batch
            const batchRegex = new RegExp(`\\(${aiBatch}\\)([^()]+)`);
            let b = s.match(batchRegex);
            if (b) {
                res.batch = clean(b[1]);
            } else {
                addError(rowNum, `Missing Batch code (${aiBatch}) in barcode`, 'warning');
            }

            // Extract Serial
            const serRegex = new RegExp(`\\(${aiSer}\\)([^()]+)`);
            let sr = s.match(serRegex);
            if (sr) {
                res.ser = clean(sr[1]);
            } else {
                res.ser = "001";
                res.isDefaultSer = true;
            }

            return res;
        };



        // --- SORT ---
        function sortBy(key, forceOrder = null) {
            if (forceOrder) {
                sortState.key = key;
                sortState.order = forceOrder;
            } else {
                if (sortState.key === key) sortState.order = sortState.order === 'asc' ? 'desc' : 'asc';
                else { sortState.key = key; sortState.order = 'asc'; }
            }

            document.querySelectorAll('.fa-sort').forEach(i => i.className = 'fas fa-sort text-gray-400 ml-1');
            const icon = document.getElementById(`icon-${key}`);
            if (icon) icon.className = `fas fa-sort-${sortState.order === 'asc' ? 'up' : 'down'} text-blue-600 ml-1`;

            displayedData.sort((a, b) => {
                let valA = a[key], valB = b[key];
                // Stock Status Sort Logic
                if (key === 'statusPriority') return (a.stockStatus?.priority || 99) - (b.stockStatus?.priority || 99) * (sortState.order === 'asc' ? 1 : -1);

                let numA = parseFloat(valA), numB = parseFloat(valB);
                if (!isNaN(numA) && !isNaN(numB) && key !== 'mat' && key !== 'custCode') { valA = numA; valB = numB; }
                else { valA = String(valA || "").toLowerCase(); valB = String(valB || "").toLowerCase(); }
                return (valA < valB ? -1 : (valA > valB ? 1 : 0)) * (sortState.order === 'asc' ? 1 : -1);
            });
            renderTable(displayedData);
        }

        // --- DATA LOADING ---
        async function loadSystemInventory(file) {
            if (!file) return;

            try {
                const rawSys = await readXlsx(file);

                // Map System with progress tracking
                // Allow flexible header names for Material
                const validMatTerms = ['material', 'mat', 'matnr', 'article', 'product', 'item', 'sku', 'part', 'code', 'model', 'identifier'];

                // Strict Header Detection: Material AND (Batch OR Qty OR Desc OR Billing)
                // This prevents picking up Title rows like "Material Report"
                let sysHeadRow = rawSys.findIndex(row => {
                    const rowStr = row.join(" ").toLowerCase();
                    const hasMat = validMatTerms.some(term => rowStr.includes(term));
                    if (!hasMat) return false;

                    const hasOther = rowStr.includes("batch") || rowStr.includes("qty") || rowStr.includes("quantity") ||
                        rowStr.includes("desc") || rowStr.includes("plant") || rowStr.includes("billing");
                    return hasOther;
                });

                // Fallback: Loose Detection (Old Logic) - Just Material
                // This ensures we support simple files that might be missing other columns
                if (sysHeadRow === -1) {
                    sysHeadRow = rawSys.findIndex(row => {
                        const rowStr = row.join(" ").toLowerCase();
                        return validMatTerms.some(term => rowStr.includes(term));
                    });
                    if (sysHeadRow > -1) console.warn("Loose Header Detection used (only Material found).");
                }

                // Fallback: If no Material found, look for Batch + Serial together
                if (sysHeadRow === -1) {
                    sysHeadRow = rawSys.findIndex(row => {
                        const s = row.join(" ").toLowerCase();
                        return (s.includes('batch') || s.includes('lot')) && (s.includes('serial') || s.includes('sno') || s.includes('ser'));
                    });
                    if (sysHeadRow > -1) console.warn("Using Fallback Header Row detection (Batch+Serial found)");
                }

                if (sysHeadRow === -1) {
                    console.error("System file missing 'Material' header.");
                    return;
                }
                const sysHeaders = rawSys[sysHeadRow].map(h => String(h).toLowerCase());

                let idxMat = sysHeaders.findIndex(h => validMatTerms.some(term => h.includes(term)));

                // Fallback: If no explicit Material col, assume Column A (Index 0)
                if (idxMat === -1) {
                    idxMat = 0;
                    console.warn("No explicit Material column matched. Defaulting to Column A.");
                }
                const idxBatch = sysHeaders.findIndex(h => h.includes("batch") || h.includes("lot"));
                const idxSer = sysHeaders.findIndex(h => h.includes("serial") || h.includes("sno"));
                const idxQty = sysHeaders.findIndex(h => h.includes("qty") || h.includes("count") || h.includes("unrestricted"));
                const idxPlant = sysHeaders.findIndex(h => h.includes("plant") || h.includes("werks") || h.includes("site"));
                const idxSloc = sysHeaders.findIndex(h => h.includes("sloc") || h.includes("loc"));
                const idxExpiry = sysHeaders.findIndex(h => h.includes("sled") || h.includes("bbd") || h.includes("expiry"));

                const idxBillDoc = sysHeaders.findIndex(h => h.includes("billing document") || h.includes("billing doc") || h.includes("bill. doc") || h.includes("bill doc"));
                const idxBillDate = sysHeaders.findIndex(h => h.includes("billing date") || h.includes("billing dt") || h.includes("bill. date") || h.includes("bill date"));

                console.log("SAP Headers Detected:", sysHeaders);
                console.log("Indices:", { idxMat, idxBatch, idxBillDoc, idxBillDate });
                const idxAge = sysHeaders.findIndex(h => h.includes("ageing") || h.includes("aging") || h.includes("inv. age"));

                // V13: Helper indices
                const idxMatchDesc = sysHeaders.findIndex(h => h.includes("desc") || h.includes("text") || h.includes("material description"));
                const idxDesc = idxMatchDesc > -1 ? idxMatchDesc : sysHeaders.findIndex(h => h.includes("name")); // Fallback

                // Enhanced Customer Detection
                const idxCustName = sysHeaders.findIndex(h => h.includes("name") || (h.includes("cust") && h.includes("desc")));
                const idxCustCode = sysHeaders.findIndex(h =>
                    (h.includes("cust") && (h.includes("code") || h.includes("id") || h.includes("no") || h.includes("num"))) ||
                    h.includes("sold-to") || h.includes("ship-to") || h.includes("payer") || h.includes("party") || h.includes("kunnr") ||
                    (h.includes("customer") && !h.includes("name"))
                );

                // Build Map-based inventory for O(1) lookups
                inventoryMap = new Map(); // Global
                totalSysItemsInitial = 0; // Use global variable

                const smartZero = document.getElementById('smartZero')?.checked || false;

                for (let i = sysHeadRow + 1; i < rawSys.length; i++) {
                    const row = rawSys[i];
                    if (!row[idxMat]) continue;

                    const item = {
                        mat: clean(row[idxMat]),
                        batch: clean(row[idxBatch]),
                        ser: idxSer > -1 ? clean(row[idxSer]) : "",
                        qty: idxQty > -1 ? (parseFloat(row[idxQty]) || 1) : 1,
                        plant: idxPlant > -1 ? clean(row[idxPlant]) : "-",
                        sloc: idxSloc > -1 ? clean(row[idxSloc]) : "-",
                        expiry: idxExpiry > -1 ? clean(row[idxExpiry]) : "-",
                        age: idxAge > -1 ? clean(row[idxAge]) : "-",
                        desc: idxDesc > -1 ? clean(row[idxDesc]) : "",
                        custName: idxCustName > -1 ? clean(row[idxCustName]) : "",
                        custCode: idxCustCode > -1 ? clean(row[idxCustCode]) : "",
                        billDoc: idxBillDoc > -1 ? clean(row[idxBillDoc]) : "",
                        billDate: idxBillDate > -1 ? clean(row[idxBillDate]) : "",
                        used: 0
                    };

                    totalSysItemsInitial += item.qty;

                    // Create multiple lookup keys for different match levels
                    // Key format: "material|batch|serial"
                    const fullKey = `${item.mat}|${item.batch}|${item.ser}`;
                    const batchKey = `${item.mat}|${item.batch}|`;
                    const matKey = `${item.mat}||`;

                    // Store with full key as primary
                    if (!inventoryMap.has(fullKey)) inventoryMap.set(fullKey, []);
                    inventoryMap.get(fullKey).push(item);

                    // Also index by batch and material for fallback matching
                    if (!inventoryMap.has(batchKey)) inventoryMap.set(batchKey, []);
                    inventoryMap.get(batchKey).push(item);

                    if (!inventoryMap.has(matKey)) inventoryMap.set(matKey, []);
                    inventoryMap.get(matKey).push(item);

                    // Smart Zero Alias Keys
                    if (smartZero) {
                        const shortMat = String(parseFloat(item.mat));
                        if (shortMat !== item.mat && !isNaN(parseFloat(item.mat))) {
                            const fullKeyS = `${shortMat}|${item.batch}|${item.ser}`;
                            const batchKeyS = `${shortMat}|${item.batch}|`;
                            const matKeyS = `${shortMat}||`;

                            if (!inventoryMap.has(fullKeyS)) inventoryMap.set(fullKeyS, []);
                            inventoryMap.get(fullKeyS).push(item);
                            if (!inventoryMap.has(batchKeyS)) inventoryMap.set(batchKeyS, []);
                            inventoryMap.get(batchKeyS).push(item);
                            if (!inventoryMap.has(matKeyS)) inventoryMap.set(matKeyS, []);
                            inventoryMap.get(matKeyS).push(item);
                        }
                    }
                }

                console.log(`Auto-loaded ${inventoryMap.size} inventory keys.`);
            } catch (e) {
                console.error("Auto-load failed:", e);
            }
        }

        const getCustomAIs = () => ({
            mat: document.getElementById('aiMaterial')?.value || '240',
            batch: document.getElementById('aiBatch')?.value || '10',
            ser: document.getElementById('aiSerial')?.value || '21'
        });

        // --- PRO BARCODE PARSER (GS1-128, Bracketed & Fallback) ---
        const parseProBarcode = (raw, rowNum = 0) => {
            if (!raw) return { mat: "", isValid: false, error: "Empty" };
            let s = String(raw).trim();
            const cf = getCustomAIs();
            let res = { mat: "", batch: "", ser: "", isDefaultSer: false, isValid: false, error: "", qty: null, expiryDate: null };

            // 1. BRACKETED FORMAT (e.g. (01)123(10)ABC)
            if (s.includes('(')) {
                s = s.replace(/[\u0000-\u001F]/g, ""); // Clean control chars

                const extract = (aiList) => {
                    if (!Array.isArray(aiList)) aiList = [aiList];
                    for (let ai of aiList) {
                        const regex = new RegExp(`\\(${ai}\\)([^()]+)`);
                        const m = s.match(regex);
                        if (m) return m[1].trim();
                    }
                    return null;
                };

                let mat = extract([cf.mat, '01', '02', '240', '241']);
                let batch = extract([cf.batch, '10', '23', '310']);
                let ser = extract([cf.ser, '21', '250']);
                let qty = extract(['37', '30']);
                let expStr = extract(['17', '15']);

                if (mat) {
                    res.mat = clean(mat);
                    if (res.mat.length === 14 && res.mat.startsWith('00')) res.mat = res.mat.substring(2);
                    res.isValid = true;
                } else {
                    res.error = "Missing Material AI";
                }

                if (batch) res.batch = clean(batch);
                else { res.batch = "-"; }

                if (ser) res.ser = clean(ser);
                else { res.ser = "001"; res.isDefaultSer = true; }

                if (qty) {
                    let q = parseFloat(qty);
                    if (!isNaN(q)) res.qty = q;
                }

                if (expStr && expStr.length >= 6) {
                    try {
                        let dStr = expStr.substring(0, 6);
                        const yy = parseInt(dStr.substring(0, 2));
                        const mm = parseInt(dStr.substring(2, 4));
                        const dd = parseInt(dStr.substring(4, 6));
                        res.expiryDate = new Date(2000 + yy, mm - 1, dd);
                    } catch (e) { }
                }

                return res;
            }

            // 2. RAW / FALLBACK (Material Only)
            if (s.length > 3) {
                res.mat = clean(s);
                res.batch = "-";
                res.ser = "001";
                res.isDefaultSer = true;
                res.isValid = true;
                res.error = "";
                return res;
            }

            return res;
        };

        // --- MAIN ---
        async function runValidation() {
            // Trigger pre-validation first
            const fScan = document.getElementById('fileScan').files[0];
            const fSys = document.getElementById('fileSystem').files[0];

            if (!fScan || !fSys) {
                alert("Please upload both files.");
                return;
            }

            const btn = document.getElementById('btnRun');
            btn.innerHTML = `<div class="spinner"></div> CHECKING FILES...`;
            btn.disabled = true;

            try {
                const { checks, allPassed } = await preValidateFiles(fScan, fSys);
                showPreValidationReport(checks, allPassed);
            } catch (e) {
                alert("Pre-validation error: " + e.message);
                btn.innerHTML = 'START VALIDATION';
                btn.disabled = false;
            }
        }

        async function actualValidation() {
            const startTime = Date.now(); // Track processing time
            const btn = document.getElementById('btnRun');
            btn.innerHTML = `<div class="spinner"></div> PROCESSING...`;
            document.getElementById('statusLog').innerHTML = "";

            const msgMatch = document.getElementById('txtMatch').value;
            const msgBatch = document.getElementById('txtBatch').value;
            const msgMat = document.getElementById('txtMat').value;
            const msgVar = document.getElementById('txtVar').value;

            // Get S.Loc Settings
            const goodSlocCode = document.getElementById('txtGoodSloc')?.value || 'RT01';
            const dmgSlocCode = document.getElementById('txtDmgSloc')?.value || 'DMG1';

            // --- [UPDATED LOGIC]: Get new settings ---
            const smartZero = document.getElementById('smartZero').checked;
            const useScanQty = document.getElementById('useScanQty').checked;
            // ----------------------------------------

            // Reset error tracking
            validationErrors = [];
            duplicateSerials = [];
            document.getElementById('errorPanel').classList.add('hidden');
            document.getElementById('duplicateWarning').classList.add('hidden');
            document.getElementById('summaryStats').classList.add('hidden');

            try {
                const fScan = document.getElementById('fileScan').files[0];
                const fSys = document.getElementById('fileSystem').files[0];
                if (!fScan || !fSys) throw new Error("Please upload both files.");

                const scanFileName = fScan.name;
                const sapFileName = fSys.name;

                updateProgress(10, 'Reading files...');
                const [rawScan, rawSys] = await Promise.all([readXlsx(fScan), readXlsx(fSys)]);

                // Check if already loaded by auto-load
                if (inventoryMap.size === 0) {
                    updateProgress(20, 'Parsing SAP system data...');
                    await loadSystemInventory(fSys);
                }

                // KPI will be updated later after counting all items in the Map
                log(`Loaded ${inventoryMap.size} unique inventory keys`);

                // Reset usage counts for re-runs to prevents stale state
                const resetCache = new Set();
                inventoryMap.forEach(items => {
                    items.forEach(item => {
                        if (!resetCache.has(item)) {
                            item.used = 0;
                            resetCache.add(item);
                        }
                    });
                });

                // --- DUPLICATE DETECTION ---
                updateProgress(30, 'Checking for duplicate serials...');
                log("Checking for duplicate serials...");
                const serialMap = new Map();
                duplicateSerials = []; // Reset

                inventoryMap.forEach((items, key) => {
                    if (key.includes('||')) return; // Skip batch/material-only keys
                    if (items.length > 1 && items[0].ser) {
                        const item = items[0];
                        // check if true duplicates (same serial) not just aliased keys
                        const uniqueItems = new Set(items);
                        if (uniqueItems.size > 1) {
                            duplicateSerials.push({
                                mat: item.mat,
                                batch: item.batch,
                                ser: item.ser,
                                count: items.length
                            });
                        }
                    }
                });

                if (duplicateSerials.length > 0) {
                    const dupWarning = document.getElementById('duplicateWarning');
                    const dupMessage = document.getElementById('duplicateMessage');
                    dupMessage.innerText = `Found ${duplicateSerials.length} duplicate serial(s) in SAP data. This may cause incorrect matching results.`;
                    dupWarning.classList.remove('hidden');
                    log(`âš ï¸ WARNING: ${duplicateSerials.length} duplicate serial(s) detected`);
                }

                // --- SMART SCAN DETECTION (HEADER vs NO HEADER) ---
                let scanHeadRow = rawScan.findIndex(row => row.join("").toLowerCase().includes("scan"));
                let scanCol = -1;
                let startRow = 0;
                let isNoHeader = false;

                // 1. Check Row 0 for actual Data (e.g. "(01)")
                if (rawScan.length > 0) {
                    const row0 = rawScan[0];
                    const row0Str = row0.join("");
                    if (row0Str.includes("(01)") || row0Str.includes("(240)")) {
                        isNoHeader = true;
                        scanCol = 0; // Assume col A
                        startRow = 0; // Start from A1
                        log("Detected: File has NO Header. Starting from A1.");
                    }
                }

                // 2. If Row 0 is NOT data, look for header
                if (!isNoHeader) {
                    if (scanHeadRow > -1) {
                        scanCol = rawScan[scanHeadRow].findIndex(c => String(c).toLowerCase().includes("scan"));
                        startRow = scanHeadRow + 1;
                        log("Detected: Header found at Row " + (scanHeadRow + 1));
                    } else {
                        // Fallback
                        startRow = 0; scanCol = 0;
                        log("Warning: No Header found, assuming A1 is data.");
                    }
                }

                // --- SCAN HEADER PARSING ---
                let scanDescCol = -1;
                let scanCustCol = -1;
                let scanCustCodeCol = -1;
                // --- [UPDATED LOGIC]: Scan Qty Column ---
                let scanQtyCol = -1;

                if (scanHeadRow >= 0) {
                    const row = rawScan[scanHeadRow].map(c => String(c).toLowerCase());
                    scanDescCol = row.findIndex(c => c.includes('desc') || c.includes('text') || c.includes('material name') || c.includes('spec') || c.includes('detail') || c.includes('title'));
                    scanCustCol = row.findIndex(c => c.includes('name') || c.includes('client') || c.includes('buyer') || c.includes('account'));
                    scanCustCodeCol = row.findIndex(c => (c.includes('cust') && (c.includes('code') || c.includes('no') || c.includes('id'))) || c.includes('party') || c.includes('sold-to') || (c.includes('customer') && !c.includes('name')));
                    // --- [UPDATED LOGIC] ---
                    if (useScanQty) {
                        scanQtyCol = row.findIndex(c => c.includes('qty') || c.includes('quantity') || c.includes('count'));
                        if (scanQtyCol > -1) log(`âœ“ Scan Qty column detected at index ${scanQtyCol}`);
                    }

                    if (scanDescCol > -1) log(`âœ“ Scan Description column detected at index ${scanDescCol}`);
                    if (scanCustCol > -1) log(`âœ“ Scan Customer Name column detected at index ${scanCustCol}`);
                    if (scanCustCodeCol > -1) log(`âœ“ Scan Customer Code column detected at index ${scanCustCodeCol}`);
                }

                // --- COLUMN B CONDITION DETECTION ---
                let conditionCol = -1;
                if (scanCol >= 0) {
                    // Check if Column B (next to scan column) exists
                    if (scanHeadRow >= 0 && rawScan[scanHeadRow].length > scanCol + 1) {
                        const nextHeader = rawScan[scanHeadRow][scanCol + 1]?.toString().toLowerCase();
                        if (nextHeader.includes('condition') || nextHeader.includes('status')) {
                            conditionCol = scanCol + 1;
                            log(`âœ“ Condition column detected at index ${conditionCol} (${rawScan[scanHeadRow][conditionCol]})`);
                        }
                    }

                    // If no header or header doesn't match, assume Column B is condition
                    if (conditionCol === -1 && rawScan[0].length > scanCol + 1) {
                        conditionCol = scanCol + 1;
                        log(`Assuming Column B (index ${conditionCol}) is condition column`);
                    }
                }

                globalData = [];
                let stats = { tot: 0, s: 0, b: 0, m: 0, v: 0 };

                // Stock status counters
                let stockStats = {
                    damage: 0,
                    expired: 0,
                    nearExpiry: 0,
                    shortExpiry: 0,
                    goodStock: 0,
                    noExpiry: 0
                };

                // Load expiry settings
                const expirySettings = loadExpirySettings();

                // Get concatenation settings
                const enableConcat = document.getElementById('enableConcat')?.checked ?? true;
                const concatDelimiter = document.getElementById('concatDelimiter')?.value ?? '';

                // Process scans with enhanced error handling and progress tracking
                updateProgress(40, 'Processing scanned items...');
                const totalScans = rawScan.length - startRow;

                // --- MULTI-PASS LOGIC (V13 Fix) ---
                // We must buffer all scans first, then run matching in priority order:
                // 1. MBS (Exact) -> 2. MB (Batch) -> 3. Mat (Material)

                let parsedScans = [];

                // PASS 0: PARSING & STATS
                for (let i = startRow; i < rawScan.length; i++) {
                    const raw = rawScan[i][scanCol];
                    if (!raw) continue;

                    const actualRowNum = i + 1;
                    const p = parseProBarcode(raw, actualRowNum);

                    // Read Scan Quantity
                    let currentScanQty = 1;
                    if (p.qty) {
                        currentScanQty = p.qty;
                    } else if (scanQtyCol > -1) {
                        let val = parseFloat(rawScan[i][scanQtyCol]);
                        if (!isNaN(val) && val > 0) currentScanQty = val;
                    }
                    stats.tot += currentScanQty;

                    // Parse other fields
                    const condition = conditionCol >= 0 ? clean(rawScan[i][conditionCol]) : '';
                    const expiryDate = p.expiryDate || parseGS1Expiry(raw);
                    const stockStatus = classifyMaterialStatus(condition, expiryDate, expirySettings);

                    // Update Stock Stats
                    switch (stockStatus.status) {
                        case 'DAMAGE': stockStats.damage++; break;
                        case 'EXPIRED': stockStats.expired++; break;
                        case 'NEAR EXPIRY': stockStats.nearExpiry++; break;
                        case 'SHORT EXPIRY': stockStats.shortExpiry++; break;
                        case 'GOOD STOCK': stockStats.goodStock++; break;
                        case 'NO EXPIRY': stockStats.noExpiry++; break;
                    }

                    // Scan Metadata
                    const scanDesc = scanDescCol > -1 ? clean(rawScan[i][scanDescCol]) : "";
                    const scanCust = scanCustCol > -1 ? clean(rawScan[i][scanCustCol]) : "";
                    const scanCustCode = scanCustCodeCol > -1 ? clean(rawScan[i][scanCustCodeCol]) : "";

                    parsedScans.push({
                        idx: i,
                        p,
                        qty: currentScanQty,
                        condition,
                        expiryDate,
                        stockStatus,
                        raw,
                        scanDesc,
                        scanCust,
                        scanCustCode,
                        matched: false,
                        matchType: null, // "Exact", "Batch Match", "Material Only", "Concat"
                        matchRef: null
                    });
                }

                // MATCHING HELPERS
                const priorityList = (document.getElementById('plantPriority')?.value || "").split(',').map(p => p.trim().toUpperCase()).filter(Boolean);
                const getBestMatch = (candidates) => {
                    if (!candidates || candidates.length === 0) return null;
                    // Only consider available inventory
                    let available = candidates.filter(inv => inv.qty - inv.used > 0);
                    if (available.length === 0) return null;

                    if (priorityList.length > 0) {
                        available.sort((a, b) => {
                            let pA = priorityList.indexOf(String(a.plant).toUpperCase());
                            let pB = priorityList.indexOf(String(b.plant).toUpperCase());
                            if (pA === -1) pA = 999;
                            if (pB === -1) pB = 999;
                            return pA - pB;
                        });
                    }
                    return available[0];
                };

                const consume = (scan, match, type) => {
                    let consumeAmount = Math.min(scan.qty, match.qty - match.used);
                    match.used += consumeAmount;
                    scan.matched = true;
                    scan.matchRef = match;
                    scan.matchType = type;
                    scan.consumed = consumeAmount;

                    if (type === 'Exact' || type === 'Concat') stats.s += consumeAmount;
                    else if (type === 'Batch Match') stats.b += consumeAmount;
                    else if (type === 'Material Only') stats.m += consumeAmount;
                };

                // PASS 1: EXACT MATCH (MBS)
                parsedScans.forEach(scan => {
                    if (!scan.p.isValid || !scan.p.mat) return;

                    // Try Exact
                    const exactKey = `${scan.p.mat}|${scan.p.batch}|${scan.p.ser}`;
                    let candidates = inventoryMap.get(exactKey);
                    let match = getBestMatch(candidates);

                    // Try Concat
                    if (!match && enableConcat) {
                        const longSerial = (scan.p.batch + concatDelimiter + scan.p.ser);
                        if (longSerial) {
                            const concatKey = `${scan.p.mat}|${scan.p.batch}|${longSerial}`;
                            candidates = inventoryMap.get(concatKey);
                            if (candidates) match = getBestMatch(candidates);
                            if (match) { consume(scan, match, "Concat"); return; }
                        }
                    }

                    if (match) { consume(scan, match, "Exact"); }
                });

                // PASS 2: BATCH MATCH (MB)
                parsedScans.forEach(scan => {
                    if (scan.matched || !scan.p.isValid || !scan.p.mat) return;

                    const batchKey = `${scan.p.mat}|${scan.p.batch}|`;
                    let candidates = inventoryMap.get(batchKey);
                    let match = getBestMatch(candidates);

                    if (match) { consume(scan, match, "Batch Match"); }
                });

                // PASS 3: MATERIAL MATCH (M)
                parsedScans.forEach(scan => {
                    if (scan.matched || !scan.p.isValid || !scan.p.mat) return;

                    const matKey = `${scan.p.mat}||`;
                    let candidates = inventoryMap.get(matKey);
                    let match = getBestMatch(candidates);

                    if (match) { consume(scan, match, "Material Only"); }
                });

                // FINAL PASS: BUILD GLOBAL DATA
                parsedScans.forEach(scan => {
                    if (!scan.p.isValid || !scan.p.mat) {
                        globalData.push({
                            status: 'Error',
                            css: 'bg-red-200 text-red-900',
                            statusPriority: -1,
                            logic: 'Parse Error',
                            detail: scan.p.error || 'Invalid barcode',
                            mat: scan.p.mat || '???',
                            phyBatch: scan.p.batch, phySer: scan.p.ser,
                            sysBatch: '-', sysSer: '-',
                            isDefaultSer: scan.p.isDefaultSer,
                            condition: scan.condition,
                            expiryDate: scan.expiryDate,
                            stockStatus: scan.stockStatus,
                            raw: scan.raw
                        });
                        stats.v++;
                        return;
                    }

                    let status = "Variance";
                    let css = "bg-red-100 text-red-800";
                    let statusPriority = 0;
                    let logic = "-";
                    let detail = msgVar;

                    const match = scan.matchRef;

                    if (scan.matched) {
                        const consumed = scan.consumed;
                        const diff = scan.qty - consumed;

                        if (diff > 0) {
                            stats.v += diff;
                            status = "Variance (Partial)";
                            css = "bg-red-50 text-red-900 border-l-4 border-red-500";
                            detail += ` | Stock Exhausted. Matched: ${consumed}, Variance: ${diff}`;
                            statusPriority = 4;
                        } else {
                            if (scan.matchType === 'Exact' || scan.matchType === 'Concat') {
                                status = "Matched"; css = "bg-green-100 text-green-800"; statusPriority = 3;
                            } else if (scan.matchType === 'Batch Match') {
                                status = "Partial"; css = "bg-yellow-100 text-yellow-800"; detail = msgBatch; statusPriority = 2;
                            } else {
                                status = "Warning"; css = "bg-orange-100 text-orange-800"; detail = msgMat; statusPriority = 1;
                            }
                        }
                        logic = scan.matchType;
                    } else {
                        stats.v += scan.qty;
                    }

                    // Metadata Lookup
                    let finalDesc = match ? (match.desc || scan.scanDesc || MATERIAL_MASTER[scan.p.mat] || "") : (scan.scanDesc || MATERIAL_MASTER[scan.p.mat] || "");
                    let finalCustCode = scan.scanCustCode || (match ? match.custCode : "") || "";
                    let masterCustName = CUSTOMER_MASTER[finalCustCode];
                    if (!masterCustName && !isNaN(parseFloat(finalCustCode))) {
                        masterCustName = CUSTOMER_MASTER[String(parseFloat(finalCustCode))];
                    }
                    masterCustName = masterCustName || "";
                    let finalCust = match ? (match.custName || scan.scanCust || masterCustName || "") : (scan.scanCust || masterCustName || "");

                    // S.Loc
                    const enableAutoSloc = document.getElementById('autoSloc')?.checked ?? true;
                    let finalSloc = enableAutoSloc ? ((scan.stockStatus.status === 'GOOD STOCK') ? goodSlocCode : dmgSlocCode) : (match ? (match.sloc || "-") : "");

                    globalData.push({
                        status, css, statusPriority, logic, detail,
                        mat: scan.p.mat,
                        desc: finalDesc,
                        cust: finalCust,
                        custCode: finalCustCode,
                        phyBatch: scan.p.batch, phySer: scan.p.ser,
                        sysBatch: match ? match.batch : '-',
                        sysSer: match ? match.ser : '-',
                        sysPlant: match ? (match.plant || '-') : '-',
                        sysExpiry: match ? (match.expiry || '-') : '-',
                        sysAge: match ? (match.age || "-") : "-",
                        sysSloc: match ? (match.sloc || '-') : '-',
                        billDoc: match ? (match.billDoc || '-') : '-',
                        billDate: match ? (match.billDate || '-') : '-',
                        sLoc: finalSloc,
                        isDefaultSer: scan.p.isDefaultSer,
                        condition: scan.condition,
                        expiryDate: scan.expiryDate,
                        stockStatus: scan.stockStatus,
                        raw: scan.raw
                    });
                });

                // CALC REMAINING with progress tracking
                updateProgress(85, 'Calculating remaining inventory...');
                let totalConsumedQty = 0;

                // --- [UPDATED LOGIC]: Count remaining qty ---
                const countedItems = new Set();
                inventoryMap.forEach((items) => {
                    items.forEach(item => {
                        // Need a unique ID for item object ref
                        if (!countedItems.has(item)) {
                            totalConsumedQty += item.used;
                            countedItems.add(item);
                        }
                    });
                });

                let remaining = totalSysItemsInitial - totalConsumedQty;

                // UPDATE KPIS
                updateProgress(90, 'Updating dashboard...');
                document.getElementById('kpi-sys-total').innerText = totalSysItemsInitial; // Show total quantity
                document.getElementById('kpi-total').innerText = stats.tot; // Show total scanned quantity

                let scanInfoText = isNoHeader
                    ? `(No Header Detected, Processed A1-End)`
                    : `(Header Detected, Processed Data after header)`;
                document.getElementById('kpi-scan-info').innerText = scanInfoText;

                document.getElementById('kpi-serial').innerText = stats.s;
                document.getElementById('kpi-batch').innerText = stats.b;
                document.getElementById('kpi-mat').innerText = stats.m;
                document.getElementById('kpi-var').innerText = stats.v;
                document.getElementById('kpi-remain').innerText = remaining;

                // Update stock status KPIs
                document.getElementById('kpi-damage').innerText = stockStats.damage;
                document.getElementById('kpi-expired').innerText = stockStats.expired;
                document.getElementById('kpi-near-expiry').innerText = stockStats.nearExpiry;
                document.getElementById('kpi-short-expiry').innerText = stockStats.shortExpiry;
                document.getElementById('kpi-good-stock').innerText = stockStats.goodStock;

                displayedData = [...globalData];
                updateProgress(95, 'Rendering results table...');
                sortBy('statusPriority');

                updateProgress(100, 'Validation complete!');
                document.getElementById('dashboard').classList.remove('hidden');

                // Show error panel if errors exist
                showErrorPanel();

                // Calculate and show summary statistics
                const processingTime = Date.now() - startTime;
                updateSummaryStats(stats, stats.tot, processingTime, scanFileName, sapFileName);

                // Save to history
                const matched = stats.s + stats.b + stats.m;
                const matchRate = stats.tot > 0 ? ((matched / stats.tot) * 100).toFixed(1) : '0';
                saveToHistory({
                    scanFile: scanFileName,
                    sapFile: sapFileName,
                    totalScanned: stats.tot,
                    matched: matched,
                    matchRate: matchRate,
                    processingTime: (processingTime / 1000).toFixed(2) + 's',
                    data: globalData
                });

                // Enhanced completion message
                let completionMsg = `<i class="fas fa-check-circle mr-2"></i> VALIDATION COMPLETE`;
                if (validationErrors.length > 0) {
                    completionMsg += ` (${validationErrors.length} warnings/errors)`;
                }
                btn.innerHTML = completionMsg;
                log("Validation Finished.");

                // Hide progress bar after 1 second
                setTimeout(hideProgress, 1000);

            } catch (e) {
                alert("Error: " + e.message);
                btn.innerHTML = "Try Again";
            }
        }

        function renderTable(data) {
            // Use active layout if available, otherwise fall back to all columns
            const layout = layouts[activeLayoutId];
            if (!layout) return;

            const tbody = document.getElementById('tableBody');
            const thead = document.querySelector('thead tr');

            // 1. Dynamic Headers
            if (thead) {
                thead.innerHTML = layout.columns.map(c => {
                    const isFiltered = activeFilters && activeFilters[c.key];
                    const iconClass = isFiltered
                        ? "fas fa-filter text-blue-600 bg-blue-50 ml-2 cursor-pointer p-1 rounded active-filter-icon shadow-sm border border-blue-200"
                        : "fas fa-filter text-gray-300 hover:text-blue-600 ml-2 cursor-pointer p-1 rounded hover:bg-gray-100 active-filter-icon";

                    return `
                    <th class="px-4 py-3 border-b relative ${c.key.includes('phy') ? 'th-phy border-l' : ''} ${c.key.includes('sys') && c.key !== 'sysPlant' ? 'th-sys' : ''}">
                        <div class="flex items-center justify-between group">
                            <div class="flex items-center cursor-pointer flex-1 hover:text-blue-700" onclick="sortBy('${c.key}')">
                                ${c.header} <i id="icon-${c.key}" class="fas fa-sort text-gray-400 ml-1 opacity-50 group-hover:opacity-100"></i>
                            </div>
                            <i onclick="openSuperFilter('${c.key}', event)" class="${iconClass}" id="filter-icon-${c.key}" title="Filter ${c.header}"></i>
                        </div>
                        <div class="resizer"></div>
                    </th>
                `}).join('');
                // Reinitialize resize after header change
                setTimeout(initResize, 100);
            }

            // 2. Dynamic Rows
            tbody.innerHTML = data.map(r => {
                let cells = layout.columns.map(col => {
                    let val = r[col.key] || '';
                    let cellClass = 'px-4 py-3 text-xs';
                    let content = '';

                    // Special formatting for specific columns
                    switch (col.key) {
                        case 'status':
                            content = `<span class="px-2 py-1 rounded text-xs font-bold ${r.css}">${r.status}</span>`;
                            break;

                        case 'logic':
                            cellClass += ' text-gray-500 font-mono';
                            content = r.logic;
                            break;

                        case 'mat':
                            cellClass += ' font-medium';
                            content = r.mat;
                            break;

                        case 'desc':
                            cellClass += ' text-gray-600 truncate max-w-xs';
                            content = `<span title="${r.desc}">${r.desc}</span>`;
                            break;

                        case 'cust':
                        case 'custCode':
                            cellClass += ' text-gray-700 font-mono';
                            content = val || '-';
                            break;

                        case 'sysPlant':
                        case 'sLoc':
                            cellClass += ' text-gray-700 font-mono text-center';
                            content = val || '-';
                            break;

                        case 'phyBatch':
                            cellClass += ' text-gray-600 bg-blue-50 border-l border-blue-200';
                            content = r.phyBatch;
                            break;

                        case 'phySer':
                            const serialClass = r.isDefaultSer ? 'default-serial px-4 py-3 text-xs border-r border-blue-200' : 'px-4 py-3 text-gray-600 text-xs border-r border-blue-200 bg-blue-50';
                            const serialIcon = r.isDefaultSer ? '<i class="fas fa-exclamation-triangle ml-1" title="Default 001"></i>' : '';
                            cellClass = serialClass;
                            content = r.phySer + serialIcon;
                            break;

                        case 'sysBatch':
                            cellClass += ' text-green-800 bg-green-50 font-bold border-l border-green-200';
                            content = r.sysBatch;
                            break;

                        case 'sysSer':
                            cellClass += ' text-green-800 bg-green-50 border-r border-green-200';
                            content = r.sysSer;
                            break;

                        case 'condition':
                            cellClass += ' text-gray-700';
                            content = r.condition || '-';
                            break;

                        case 'expiryDate':
                            cellClass += ' text-gray-700 font-mono';
                            content = r.expiryDate ? r.expiryDate.toLocaleDateString('en-GB') : '-';
                            break;

                        case 'sysExpiry':
                            cellClass += ' text-green-700 font-mono';
                            content = r.sysExpiry || '-';
                            break;

                        case 'billDoc':
                            cellClass += ' text-gray-700 font-mono';
                            content = r.billDoc || '-';
                            break;

                        case 'billDate':
                            cellClass += ' text-gray-700';
                            content = r.billDate || '-';
                            break;

                        case 'daysLeft':
                            cellClass += ' fw-bold text-right';
                            content = r.stockStatus?.daysLeft !== null && r.stockStatus?.daysLeft !== undefined ? r.stockStatus.daysLeft + 'd' : '-';
                            break;

                        case 'stockStatus':
                            cellClass = 'px-4 py-3 text-xs';
                            content = `<span class="px-2 py-1 rounded border ${r.stockStatus?.css || 'bg-gray-100 text-gray-400'}">${r.stockStatus?.icon || ''} ${r.stockStatus?.status || '-'}</span>`;
                            break;

                        case 'detail':
                            cellClass += ' text-gray-400 italic';
                            content = r.detail;
                            break;

                        case 'raw':
                            cellClass += ' text-gray-400 font-mono truncate max-w-xs';
                            content = `<span title="${r.raw}">${r.raw}</span>`;
                            break;

                        default:
                            content = val;
                    }

                    return `<td class="${cellClass}">${content}</td>`;
                }).join('');

                return `<tr class="hover:bg-gray-50 border-b border-gray-100 transition">${cells}</tr>`;
            }).join('');
        }

        // ==========================================
        // SUPER FILTER LOGIC
        // ==========================================
        let activeFilters = {};

        function openSuperFilter(key, event) {
            event.stopPropagation();
            const existing = document.querySelector('.super-filter-panel');
            if (existing) existing.remove();

            const panel = document.createElement('div');
            panel.className = 'super-filter-panel animate-fade';

            // Positioning
            let left = event.pageX;
            if (left + 280 > window.innerWidth) left = window.innerWidth - 300;
            panel.style.left = `${left}px`;
            panel.style.top = `${event.pageY + 10}px`;

            // Data Analysis
            const counts = {};
            let isNumeric = true;
            let isDate = key.toLowerCase().includes('date') || key.toLowerCase().includes('expiry');

            globalData.forEach(r => {
                const v = r[key] || "(Blank)";
                counts[v] = (counts[v] || 0) + 1;
                // Check numeric
                if (isNumeric && v !== "(Blank)" && isNaN(parseFloat(v))) isNumeric = false;
            });
            const uniqueValues = Object.keys(counts).sort();

            // Active State
            const active = activeFilters[key] || { values: null, min: "", max: "" };
            const minVal = active.min || "";
            const maxVal = active.max || "";

            let html = `
                <div class="filter-header">
                    <span class="font-bold text-xs uppercase text-gray-500 tracking-wider">Filter: ${key}</span>
                    <button onclick="this.closest('.super-filter-panel').remove()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
                
                <!-- SORT BUTTONS -->
                <div class="p-2 border-b bg-gray-50 flex gap-2">
                    <button onclick="sortBy('${key}', 'asc'); document.querySelector('.super-filter-panel').remove()" class="flex-1 bg-white border rounded p-1 text-xs hover:bg-blue-50 text-gray-600 flex items-center justify-center gap-1 shadow-sm"><i class="fas fa-arrow-down-a-z text-blue-500"></i> ${isNumeric ? 'Smallest' : 'Ascending'}</button>
                    <button onclick="sortBy('${key}', 'desc'); document.querySelector('.super-filter-panel').remove()" class="flex-1 bg-white border rounded p-1 text-xs hover:bg-blue-50 text-gray-600 flex items-center justify-center gap-1 shadow-sm"><i class="fas fa-arrow-down-z-a text-blue-500"></i> ${isNumeric ? 'Largest' : 'Descending'}</button>
                </div>

                <!-- RANGE / CONDITION FILTER -->
                <div class="p-2 border-b bg-white">
                    <div class="text-[10px] font-bold text-gray-400 uppercase mb-1">
                         ${isDate ? 'Date Range' : (isNumeric ? 'Number Range' : 'Text Search')}
                    </div>
            `;

            if (isNumeric || isDate) {
                html += `
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="filter-min-${key}" value="${minVal}" placeholder="${isDate ? 'YYYY-MM-DD' : 'Min / >'}" class="w-1/2 text-xs p-1 border rounded focus:border-blue-500">
                        <input type="text" id="filter-max-${key}" value="${maxVal}" placeholder="${isDate ? 'YYYY-MM-DD' : 'Max / <'}" class="w-1/2 text-xs p-1 border rounded focus:border-blue-500">
                    </div>
                 `;
            }

            html += `
                    <input type="text" placeholder="Search List..." class="w-full text-xs p-2 border rounded bg-gray-50 focus:bg-white focus:outline-blue-500 transition" onkeyup="filterFilterList(this)">
                </div>
                
                <div class="filter-body text-left">
                    <label class="filter-row font-bold text-blue-600 border-b mb-1 pb-1">
                        <input type="checkbox" onchange="toggleAllFilters(this)" class="mr-2 rounded text-blue-600">
                        Select All
                    </label>
            `;

            uniqueValues.forEach(v => {
                const safeV = String(v).replace(/"/g, '&quot;');
                // Check logic: If filter is active, check if value in set. If NO filter active (new), keys checked? 
                // Usually "Select All". If active filter exists, use it.
                // If active.values is NULL, it means "All Selected" (implied) or range only.
                // If filter exists but values is null, assume all checked.
                const isChecked = (!activeFilters[key] || !activeFilters[key].values || activeFilters[key].values.has(v)) ? 'checked' : '';

                html += `
                    <label class="filter-row">
                        <input type="checkbox" value="${safeV}" ${isChecked} class="mr-2 rounded text-blue-600 filter-check">
                        <span class="text-xs truncate flex-1" title="${safeV}">${v}</span>
                        <span class="text-[10px] text-gray-400 bg-gray-100 px-1 rounded ml-1">${counts[v]}</span>
                    </label>
                `;
            });

            html += `</div>
                <div class="filter-footer">
                    <button onclick="clearFilter('${key}')" class="text-xs text-gray-500 font-bold hover:text-red-600 mr-auto">Clear</button>
                    <button onclick="applyFilter('${key}', this)" class="bg-blue-600 text-white px-4 py-1.5 rounded text-xs font-bold hover:bg-blue-700 shadow-sm transition">APPLY</button>
                </div>
            `;

            panel.innerHTML = html;
            document.body.appendChild(panel);

            setTimeout(() => {
                const closer = (e) => {
                    if (!panel.contains(e.target) && !e.target.closest('.active-filter-icon')) {
                        panel.remove();
                        document.removeEventListener('click', closer);
                    }
                };
                document.addEventListener('click', closer);
            }, 100);
        }

        function filterFilterList(input) {
            const term = input.value.toLowerCase();
            const labels = input.parentElement.parentElement.querySelectorAll('.filter-body .filter-row:not(:first-child)'); // Adjusted selector
            labels.forEach(l => {
                const txt = l.querySelector('span').innerText.toLowerCase();
                l.style.display = txt.includes(term) ? 'flex' : 'none';
            });
        }

        function toggleAllFilters(source) {
            const inputs = source.closest('.filter-body').querySelectorAll('.filter-check');
            inputs.forEach(i => {
                if (i.parentElement.style.display !== 'none') i.checked = source.checked;
            });
        }

        function applyFilter(key, btn) {
            const panel = btn.closest('.super-filter-panel');
            const inputs = panel.querySelectorAll('.filter-check:checked');
            const totalInputs = panel.querySelectorAll('.filter-check').length;
            const values = new Set();
            inputs.forEach(i => values.add(i.value));

            // Logic: Is it a Subset?
            // If Checked < Total, we have a list filter.
            // OR if Range inputs have value.

            const minInput = document.getElementById(`filter-min-${key}`);
            const maxInput = document.getElementById(`filter-max-${key}`);
            const minVal = minInput ? minInput.value.trim() : "";
            const maxVal = maxInput ? maxInput.value.trim() : "";

            const hasRange = minVal !== "" || maxVal !== "";
            // Special Case: If ALL checked and NO range => No Filter.
            // If SOME checked OR Range => Filter Active.

            if (inputs.length === totalInputs && !hasRange) {
                // Clear Filter
                delete activeFilters[key];
                const icon = document.getElementById('filter-icon-' + key);
                if (icon) icon.className = 'fas fa-filter text-gray-300 hover:text-blue-600 ml-2 cursor-pointer p-1 rounded hover:bg-gray-100 active-filter-icon';
            } else {
                // Active Filter
                activeFilters[key] = {
                    type: 'complex',
                    values: inputs.length < totalInputs ? values : null, // Null means "All List Items" (checked)
                    min: minVal,
                    max: maxVal
                };
                const icon = document.getElementById('filter-icon-' + key);
                if (icon) icon.className = 'fas fa-filter text-blue-600 bg-blue-50 ml-2 cursor-pointer p-1 rounded active-filter-icon shadow-sm border border-blue-200';
            }

            if (panel) panel.remove();
            runSuperFilter();
        }

        function clearFilter(key) {
            delete activeFilters[key];
            const icon = document.getElementById('filter-icon-' + key);
            if (icon) icon.className = 'fas fa-filter text-gray-300 hover:text-blue-600 ml-2 cursor-pointer p-1 rounded hover:bg-gray-100 active-filter-icon';

            const panel = document.querySelector('.super-filter-panel');
            if (panel) panel.remove();

            runSuperFilter();
        }

        function runSuperFilter() {
            filterData();
        }

        function filterData() {
            const term = document.getElementById('searchBox').value.toLowerCase();

            displayedData = globalData.filter(r => {
                // 1. Global Search
                if (term) {
                    const matchGlobal = Object.values(r).some(v => String(v).toLowerCase().includes(term));
                    if (!matchGlobal) return false;
                }

                // 2. Super Filters
                for (const key in activeFilters) {
                    const f = activeFilters[key];
                    let val = r[key];

                    // A) List Filter (Set) - Only if values is NOT null
                    if (f.values) {
                        const safeV = String(val || "(Blank)").replace(/"/g, '&quot;');
                        if (!f.values.has(safeV)) return false;
                    }

                    // B) Range Filter (Min/Max)
                    if (f.min || f.max) {
                        let numVal = parseFloat(val);
                        // Date parsing if key implies?
                        if (key.toLowerCase().includes('date') || key.toLowerCase().includes('expiry')) {
                            // Attempt to parse Date
                            let d = new Date(val); // Assuming val is Date obj or string
                            if (val instanceof Date) d = val;
                            // Compare time?
                            if (f.min) {
                                let minD = new Date(f.min);
                                if (!isNaN(minD) && d < minD) return false;
                            }
                            if (f.max) {
                                let maxD = new Date(f.max);
                                if (!isNaN(maxD) && d > maxD) return false;
                            }
                        } else if (!isNaN(numVal)) {
                            // Numeric
                            if (f.min !== "" && !isNaN(parseFloat(f.min)) && numVal < parseFloat(f.min)) return false;
                            if (f.max !== "" && !isNaN(parseFloat(f.max)) && numVal > parseFloat(f.max)) return false;
                        }
                    }
                }

                return true;
            });

            renderTable(displayedData);
            updateFilterChips();
        }

        function updateFilterChips() {
            const bar = document.getElementById('activeFiltersBar');
            if (!bar) return;

            if (Object.keys(activeFilters).length === 0) {
                bar.innerHTML = '';
                bar.classList.add('hidden');
                return;
            }

            bar.classList.remove('hidden');
            let html = '<span class="text-xs font-bold text-gray-400 mr-2 flex items-center uppercase tracking-wider"><i class="fas fa-filter mr-1"></i> Active:</span>';

            for (const key in activeFilters) {
                const f = activeFilters[key];
                // Lookup header label
                const layout = layouts[activeLayoutId];
                const colDef = layout.columns.find(c => c.key === key);
                const label = colDef ? colDef.header : key;

                let parts = [];
                // List Filter
                if (f.values) {
                    const arr = [...f.values];
                    // Unescape for display
                    if (arr.length === 1) parts.push(arr[0].replace(/&quot;/g, '"'));
                    else parts.push(`${arr.length} selected`);
                }

                // Range Filter
                if (f.min) parts.push(`â‰¥ ${f.min}`);
                if (f.max) parts.push(`â‰¤ ${f.max}`);

                if (parts.length === 0) parts.push("Active");

                html += `
                    <div class="filter-chip">
                        <span class="text-blue-800">${label}: <b class="text-black">${parts.join(' & ')}</b></span>
                        <button onclick="clearFilter('${key}')" class="hover:bg-blue-200 rounded-full w-4 h-4 flex items-center justify-center"><i class="fas fa-times text-[9px]"></i></button>
                    </div>
                `;
            }

            html += `<button onclick="clearAllFilters()" class="text-[10px] text-gray-500 hover:text-red-600 underline ml-2 font-bold decoration-dotted">CLEAR ALL</button>`;
            bar.innerHTML = html;
        }

        function clearAllFilters() {
            activeFilters = {};
            document.querySelectorAll('.active-filter-icon').forEach(i => i.className = 'fas fa-filter text-gray-300 hover:text-blue-600 ml-2 cursor-pointer p-1 rounded hover:bg-gray-100 active-filter-icon');
            filterData();
        }

        function exportResult() {
            if (globalData.length === 0) { alert("No data to export"); return; }
            const wb = XLSX.utils.book_new();

            // --- SHEET 1: Validation Results (Custom Layout & Style) ---
            let layoutStr = document.getElementById('exportLayout')?.value || "";
            if (!layoutStr.trim()) layoutStr = "Status, Logic, Material, Description, Customer Name, Customer Code, Plant, S.Loc, Phy Batch, Phy Serial, Sys Batch, Sys Serial, Condition, Expiry Date, Sys Expiry, Days Left, Stock Status, Comment";
            const keys = layoutStr.split(',').map(k => k.trim());

            const proData = [];
            // Header
            proData.push(keys.map(h => ({
                v: h, t: 's',
                s: { fill: { fgColor: { rgb: "4F81BD" } }, font: { color: { rgb: "FFFFFF" }, bold: true }, border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } }, alignment: { horizontal: "center" } }
            })));

            // Rows
            globalData.forEach(item => {
                const row = keys.map(key => {
                    let val = "";
                    switch (key.toLowerCase()) {
                        case 'status': val = item.status; break;
                        case 'logic': val = item.logic; break;
                        case 'material': val = item.mat; break;
                        case 'description': val = item.desc; break;
                        case 'customer':
                        case 'customer name': val = item.cust; break;
                        case 'customer code': val = item.custCode; break;
                        case 'plant': val = item.sysPlant; break;
                        case 's.loc': val = item.sLoc; break;
                        case 'phy batch': val = item.phyBatch; break;
                        case 'phy serial': val = item.phySer; break;
                        case 'sys batch': val = item.sysBatch; break;
                        case 'sys serial': val = item.sysSer; break;
                        case 'condition': val = item.condition; break;
                        case 'expiry date': val = item.expiryDate ? item.expiryDate.toLocaleDateString('en-GB') : ""; break;
                        case 'sys expiry': val = item.sysExpiry; break;
                        case 'ageing': val = item.sysAge; break;
                        case 'days left': val = item.stockStatus?.daysLeft !== undefined && item.stockStatus?.daysLeft !== null ? item.stockStatus.daysLeft : ""; break;
                        case 'stock status': val = item.stockStatus?.status || ""; break;
                        case 'bill doc':
                        case 'billing doc':
                        case 'billing document': val = item.billDoc || ""; break;
                        case 'bill date':
                        case 'billing date': val = item.billDate || ""; break;
                        case 'comment': val = item.detail; break;
                        default: val = "";
                    }
                    return {
                        v: val, t: 's',
                        s: { border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } } }
                    };
                });
                proData.push(row);
            });

            const wsResults = XLSX.utils.aoa_to_sheet(proData);
            wsResults['!cols'] = keys.map(() => ({ wch: 20 }));
            XLSX.utils.book_append_sheet(wb, wsResults, "Validation Results");

            // --- AUX SHEETS ---
            const damageData = globalData.filter(r => r.stockStatus?.status === 'DAMAGE').map(r => ({ Material: r.mat, Batch: r.phyBatch, Serial: r.phySer, Link: r.detail }));
            if (damageData.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(damageData), "Damage Report");

            const expiryData = globalData.filter(r => ['EXPIRED', 'NEAR EXPIRY'].includes(r.stockStatus?.status)).map(r => ({ Status: r.stockStatus?.status, Material: r.mat, Expiry: r.expiryDate }));
            if (expiryData.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(expiryData), "Expiry Report");

            const summaryData = [{ Property: 'Scan File', Value: document.getElementById('stat-scan-file')?.innerText || '-' }];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summaryData), "Metadata");

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            XLSX.writeFile(wb, `ZCPU_Validation_v13_${timestamp}.xlsx`);
        }

        // --- RESIZE LOGIC (V13 - FIXED) ---
        function initResize() {
            const cols = document.querySelectorAll('th');
            cols.forEach((col) => {
                const resizer = col.querySelector('.resizer');
                if (!resizer) return;
                let x = 0; let w = 0;

                const mouseDownHandler = (e) => {
                    // STOP PROPAGATION HERE TO PREVENT SORT
                    e.stopPropagation();
                    e.preventDefault();

                    x = e.clientX;
                    const styles = window.getComputedStyle(col);
                    w = parseInt(styles.width, 10);
                    document.addEventListener('mousemove', mouseMoveHandler);
                    document.addEventListener('mouseup', mouseUpHandler);
                    resizer.classList.add('resizing');
                };

                const mouseMoveHandler = (e) => {
                    const dx = e.clientX - x;
                    col.style.width = `${w + dx}px`;
                };

                const mouseUpHandler = () => {
                    document.removeEventListener('mousemove', mouseMoveHandler);
                    document.removeEventListener('mouseup', mouseUpHandler);
                    resizer.classList.remove('resizing');
                };

                // Add click listener to stop bubble on click too
                resizer.addEventListener('click', (e) => e.stopPropagation());
                resizer.addEventListener('mousedown', mouseDownHandler);
            });
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            initDB();
            initResize();
            renderQuickExportButtons();
        });

        // ==========================================
        // ADVANCED LAYOUT MANAGER LOGIC
        // ==========================================

        // 1. Define Columns (Ensure these keys match your data keys)
        const ALL_COLUMNS = [
            { key: 'status', label: 'Match Status', default: true },
            { key: 'logic', label: 'Logic', default: true },
            { key: 'mat', label: 'Material', default: true },
            { key: 'desc', label: 'Description', default: true },
            { key: 'billDoc', label: 'Billing Doc', default: true },
            { key: 'billDate', label: 'Billing Date', default: true },
            { key: 'cust', label: 'Customer Name', default: true },
            { key: 'custCode', label: 'Customer Code', default: true },
            { key: 'sysPlant', label: 'Plant', default: true },
            { key: 'sLoc', label: 'Storage Loc', default: true },
            { key: 'phyBatch', label: 'Phy Batch', default: true },
            { key: 'phySer', label: 'Phy Serial', default: true },
            { key: 'sysBatch', label: 'Sys Batch', default: true },
            { key: 'sysSer', label: 'Sys Serial', default: true },
            { key: 'condition', label: 'Condition', default: true },
            { key: 'expiryDate', label: 'Expiry Date', default: false },
            { key: 'sysExpiry', label: 'Sys Expiry', default: false },
            { key: 'sysAge', label: 'Ageing', default: true },
            { key: 'stockStatus', label: 'Stock Status', default: true },
            { key: 'detail', label: 'Comment', default: true },
            { key: 'raw', label: 'Scan String', default: false }
        ];

        let layouts = JSON.parse(localStorage.getItem('sapVal_layouts_v3') || '{}');
        let activeLayoutId = 'standard';
        let editingLayout = [];

        // Initialize Default if empty
        if (Object.keys(layouts).length === 0) {
            layouts['standard'] = {
                name: 'Standard View',
                columns: ALL_COLUMNS.filter(c => c.default).map(c => ({ ...c, header: c.label, width: 15 }))
            };
            layouts['simple'] = {
                name: 'Simple Check',
                columns: ALL_COLUMNS.filter(c => ['status', 'mat', 'phyBatch', 'phySer'].includes(c.key)).map(c => ({ ...c, header: c.label, width: 20 }))
            };
            localStorage.setItem('sapVal_layouts_v3', JSON.stringify(layouts));
        }

        // --- Functions ---

        function renderSavedLayoutsList() {
            const list = document.getElementById('savedLayoutsList');
            list.innerHTML = '';
            Object.keys(layouts).forEach(id => {
                const div = document.createElement('div');
                div.className = `p-2 cursor-pointer hover:bg-blue-50 rounded flex justify-between items-center ${id === activeLayoutId ? 'bg-blue-100 border-l-4 border-blue-600' : ''}`;
                div.innerText = layouts[id].name;
                div.onclick = () => { activeLayoutId = id; renderSavedLayoutsList(); loadLayoutToEditor(id); };
                list.appendChild(div);
            });
        }

        function loadLayoutToEditor(id) {
            activeLayoutId = id;
            renderSavedLayoutsList();
            const layout = layouts[id];
            document.getElementById('layoutNameInput').value = layout.name;

            // Merge logic
            const enabledMap = new Map(layout.columns.map(c => [c.key, c]));
            editingLayout = [];
            layout.columns.forEach(c => editingLayout.push({ ...c, enabled: true }));
            ALL_COLUMNS.forEach(def => {
                if (!enabledMap.has(def.key)) {
                    editingLayout.push({ key: def.key, label: def.label, header: def.label, width: 15, enabled: false });
                }
            });
            renderColumnEditor();
        }

        function renderColumnEditor() {
            const list = document.getElementById('columnEditorList');
            list.innerHTML = '';
            editingLayout.forEach((col, index) => {
                const div = document.createElement('div');
                div.className = `grid grid-cols-12 gap-2 p-2 items-center border-b ${col.enabled ? 'bg-white' : 'bg-gray-100 opacity-60'}`;
                div.innerHTML = `
                    <div class="col-span-1 text-center"><input type="checkbox" onchange="toggleCol(${index})" ${col.enabled ? 'checked' : ''}></div>
                    <div class="col-span-4 text-xs font-bold truncate">${col.label}</div>
                    <div class="col-span-4"><input type="text" value="${col.header}" onchange="editCol(${index}, 'header', this.value)" class="border p-1 w-full text-xs" ${!col.enabled ? 'disabled' : ''}></div>
                    <div class="col-span-1"><input type="number" value="${col.width}" onchange="editCol(${index}, 'width', this.value)" class="border p-1 w-full text-xs" ${!col.enabled ? 'disabled' : ''}></div>
                    <div class="col-span-2 text-center">
                        <button onclick="moveCol(${index}, -1)" class="text-blue-600 font-bold px-1">â†‘</button>
                        <button onclick="moveCol(${index}, 1)" class="text-blue-600 font-bold px-1">â†“</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function toggleCol(i) { editingLayout[i].enabled = !editingLayout[i].enabled; renderColumnEditor(); }
        function editCol(i, k, v) { editingLayout[i][k] = v; }
        function moveCol(i, d) {
            const t = i + d;
            if (t >= 0 && t < editingLayout.length) {
                [editingLayout[i], editingLayout[t]] = [editingLayout[t], editingLayout[i]];
                renderColumnEditor();
            }
        }

        function createNewLayout() {
            const id = 'cust_' + Date.now();
            layouts[id] = { name: 'New Layout', columns: ALL_COLUMNS.filter(c => c.default).map(c => ({ ...c, header: c.label, width: 15 })) };
            loadLayoutToEditor(id);
        }

        function saveCurrentLayout() {
            const name = document.getElementById('layoutNameInput').value;
            if (!name) return alert("Name required");
            const finalCols = editingLayout.filter(c => c.enabled).map(c => ({ key: c.key, label: c.label, header: c.header, width: c.width }));
            layouts[activeLayoutId] = { name: name, columns: finalCols };
            localStorage.setItem('sapVal_layouts_v3', JSON.stringify(layouts));
            renderSavedLayoutsList();
            renderQuickExportButtons();
            alert("Layout Saved!");
        }

        function deleteCurrentLayout() {
            if (Object.keys(layouts).length <= 1) return alert("Keep at least one layout");
            delete layouts[activeLayoutId];
            activeLayoutId = Object.keys(layouts)[0];
            localStorage.setItem('sapVal_layouts_v3', JSON.stringify(layouts));
            loadLayoutToEditor(activeLayoutId);
            renderQuickExportButtons();
        }

        function renderQuickExportButtons() {
            const c = document.getElementById('quickExportButtons');
            if (!c) return;
            c.innerHTML = '';
            Object.keys(layouts).forEach(id => {
                const l = layouts[id];
                const isActive = id === activeLayoutId;
                const btn = document.createElement('div');
                btn.className = `cursor-pointer px-3 py-1 text-xs rounded flex items-center gap-2 border ${isActive ? 'bg-white text-black font-bold' : 'bg-gray-700 border-gray-600 hover:bg-gray-600'}`;
                btn.innerHTML = `
                    <span onclick="applyLayout('${id}')">${l.name}</span>
                    <i class="fas fa-file-excel hover:text-green-400 pl-2 border-l border-gray-500" onclick="exportFormatted('${id}')" title="Export"></i>
                `;
                c.appendChild(btn);
            });
        }

        function applyLayout(id) {
            activeLayoutId = id;
            renderQuickExportButtons();
            // Re-render table with new layout
            renderTable(displayedData.length > 0 ? displayedData : globalData);
        }

        // --- ADVANCED EXPORT ---
        function exportFormatted(layoutId) {
            if (!globalData || !globalData.length) return alert("No data");
            const layout = layouts[layoutId];

            // Header
            const header = layout.columns.map(c => ({
                v: c.header, t: 's', s: { font: { bold: true, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "4472C4" } }, alignment: { horizontal: "center" } }
            }));

            // Data
            const rows = globalData.map((r, i) => {
                return layout.columns.map(c => {
                    let val = r[c.key] || '';

                    // Handle stock status object
                    if (c.key === 'stockStatus' && typeof val === 'object') {
                        val = val.status || '';
                    }

                    // Handle expiry date object
                    if (c.key === 'expiryDate' && val instanceof Date) {
                        val = val.toLocaleDateString();
                    }

                    // Strip HTML from any field
                    if (typeof val === 'string' && val.includes('<')) val = val.replace(/<[^>]*>?/gm, '');

                    let color = "000000";
                    if (val === 'Matched') color = "008000";
                    if (val === 'Variance' || val === 'Error') color = "FF0000";
                    if (val === 'Partial') color = "FFA500";
                    if (val === 'Warning') color = "FF8C00";

                    return {
                        v: val, t: 's',
                        s: { fill: { fgColor: { rgb: i % 2 === 0 ? "FFFFFF" : "F2F2F2" } }, font: { color: { rgb: color } }, border: { bottom: { style: 'thin', color: { rgb: "CCCCCC" } } } }
                    };
                });
            });

            const ws = XLSX.utils.aoa_to_sheet([header, ...rows]);
            ws['!cols'] = layout.columns.map(c => ({ wch: parseInt(c.width) || 15 }));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Report");
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            XLSX.writeFile(wb, `${layout.name}_Export_${timestamp}.xlsx`);
        }

        // ==========================================
        // LIVE SCAN MODE LOGIC
        // ==========================================

        let liveSessionData = [];
        let liveSessionStats = { matched: 0, variance: 0, duplicate: 0, total: 0 };
        let liveScanActive = false;
        let liveScanPaused = false;
        let inventoryMapForLive = new Map(); // Deep copy for live consumption
        let scannedSerials = new Set(); // For duplicate detection
        let liveScanCondition = 'Good';

        function setLiveCondition(cond) {
            liveScanCondition = cond;
            const btnGood = document.getElementById('btnCondGood');
            const btnDamage = document.getElementById('btnCondDamage');
            const header = document.querySelector('#liveScanModal > div:first-child');

            // Reset styles
            btnGood.className = 'px-6 py-2 rounded font-bold bg-transparent text-gray-300 hover:text-white transition';
            btnDamage.className = 'px-6 py-2 rounded font-bold bg-transparent text-gray-300 hover:text-white transition';

            if (cond === 'Good') {
                btnGood.className = 'px-6 py-2 rounded font-bold bg-green-500 text-white shadow ring-2 ring-white';
                header.className = 'bg-green-800 text-white p-4 flex justify-between items-center shadow-lg transition-colors duration-300';
            } else {
                btnDamage.className = 'px-6 py-2 rounded font-bold bg-red-600 text-white shadow ring-2 ring-white';
                header.className = 'bg-red-800 text-white p-4 flex justify-between items-center shadow-lg transition-colors duration-300';
            }
            document.getElementById('liveScanInput').focus();
        }

        // Sound Generation
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;

        function playSound(type) {
            if (!audioCtx) audioCtx = new AudioContext();

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'success') {
                oscillator.frequency.value = 800;
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.2);
            } else if (type === 'error') {
                oscillator.frequency.value = 300;
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.3);
            } else if (type === 'duplicate') {
                // Double beep
                oscillator.frequency.value = 600;
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.15);

                setTimeout(() => {
                    const osc2 = audioCtx.createOscillator();
                    const gain2 = audioCtx.createGain();
                    osc2.connect(gain2);
                    gain2.connect(audioCtx.destination);
                    osc2.frequency.value = 600;
                    gain2.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                    osc2.start(audioCtx.currentTime);
                    osc2.stop(audioCtx.currentTime + 0.15);
                }, 200);
            }
        }

        function enableBulkMode() {
            // Show bulk section immediately
            const bulkSection = document.getElementById('bulkUploadSection');
            bulkSection.classList.remove('hidden');

            // Scroll to it
            setTimeout(() => {
                bulkSection.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        function openLiveScanMode() {
            // Check if SAP file uploaded - warning only, don't block
            if (!inventoryMap || inventoryMap.size === 0) {
                console.warn("Live Scan started without SAP data");
                // Optional: alert("âš ï¸ Warning: No SAP file loaded. All scans will be 'Variance'.");
            }

            // Initialize session
            liveSessionData = [];
            liveSessionStats = { matched: 0, variance: 0, duplicate: 0, total: 0 };
            scannedSerials = new Set();
            liveScanActive = true;
            liveScanPaused = false;

            // Deep copy inventory map (Safely)
            inventoryMapForLive = new Map();
            const itemCache = new Map(); // Cache to preserve object references

            if (inventoryMap && inventoryMap.size > 0) {
                inventoryMap.forEach((items, key) => {
                    const matchedItems = items.map(item => {
                        if (!itemCache.has(item)) {
                            // Link new live item to original to preserve shared state logic in live map
                            itemCache.set(item, { ...item, used: item.used || 0 });
                        }
                        return itemCache.get(item);
                    });
                    inventoryMapForLive.set(key, matchedItems);
                });
            }

            // Show modal
            document.getElementById('liveScanModal').classList.remove('hidden');

            // Focus input
            setTimeout(() => {
                const input = document.getElementById('liveScanInput');
                input.value = '';
                input.focus();
            }, 100);

            updateLiveStats();
            renderLiveScansTable();
        }

        function closeLiveScanMode() {
            if (liveSessionData.length > 0) {
                if (!confirm("âš ï¸ Session data will be lost. Continue?")) return;
            }
            document.getElementById('liveScanModal').classList.add('hidden');
            liveScanActive = false;
        }

        function toggleLivePause() {
            liveScanPaused = !liveScanPaused;
            const btn = document.getElementById('livePauseBtn');
            const input = document.getElementById('liveScanInput');

            if (liveScanPaused) {
                btn.innerHTML = '<i class="fas fa-play mr-2"></i> RESUME';
                btn.className = 'bg-green-500 hover:bg-green-600 px-4 py-2 rounded font-bold';
                input.disabled = true;
                input.classList.add('opacity-50');
            } else {
                btn.innerHTML = '<i class="fas fa-pause mr-2"></i> PAUSE';
                btn.className = 'bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded font-bold';
                input.disabled = false;
                input.classList.remove('opacity-50');
                input.focus();
            }
        }

        // Main validation function
        function validateLiveScan(barcode) {
            if (liveScanPaused) return;

            const parsed = parseProBarcode(barcode.trim());
            if (!parsed || !parsed.mat) {
                showLiveStatus('error', 'INVALID BARCODE', 'Could not parse barcode');
                playSound('error');
                return;
            }

            const { mat, batch, ser } = parsed;
            const serialKey = `${mat}|${batch}|${ser}`;

            // Check for duplicate
            if (scannedSerials.has(serialKey)) {
                showLiveStatus('duplicate', 'DUPLICATE SCAN', `Serial already scanned!`);
                playSound('duplicate');
                liveSessionStats.duplicate++;
                liveSessionStats.total++;

                liveSessionData.unshift({
                    time: new Date().toLocaleTimeString(),
                    mat, batch, ser,
                    status: 'DUPLICATE',
                    condition: liveScanCondition,
                    detail: 'Already scanned in this session',
                    barcode
                });

                updateLiveStats();
                renderLiveScansTable();
                return;
            }

            // Try to find and consume stock
            let matchFound = false;
            let matchDetail = '';

            // Exact match
            const exactKey = `${mat}|${batch}|${ser}`;
            if (inventoryMapForLive.has(exactKey)) {
                const items = inventoryMapForLive.get(exactKey);
                for (let item of items) {
                    if ((item.qty - item.used) > 0) {
                        item.used++;
                        matchFound = true;
                        matchDetail = `Remaining: ${item.qty - item.used}`;
                        break;
                    }
                }
            }

            // Batch match (if exact not found)
            if (!matchFound) {
                const batchKey = `${mat}|${batch}|`;
                inventoryMapForLive.forEach((items, key) => {
                    if (key.startsWith(batchKey) && !matchFound) {
                        for (let item of items) {
                            if ((item.qty - item.used) > 0) {
                                item.used++;
                                matchFound = true;
                                matchDetail = `Batch match | Rem: ${item.qty - item.used}`;
                                break;
                            }
                        }
                    }
                });
            }

            if (matchFound) {
                showLiveStatus('success', 'âœ… MATCHED', matchDetail);
                playSound('success');
                liveSessionStats.matched++;
                scannedSerials.add(serialKey);

                liveSessionData.unshift({
                    time: new Date().toLocaleTimeString(),
                    mat, batch, ser,
                    status: 'MATCHED',
                    condition: liveScanCondition,
                    detail: matchDetail,
                    barcode
                });
            } else {
                showLiveStatus('error', 'âŒ VARIANCE', 'Not in SAP or Stock exhausted');
                playSound('error');
                liveSessionStats.variance++;
                scannedSerials.add(serialKey);

                liveSessionData.unshift({
                    time: new Date().toLocaleTimeString(),
                    mat, batch, ser,
                    status: 'VARIANCE',
                    condition: liveScanCondition,
                    detail: 'Not found in SAP inventory',
                    barcode
                });
            }

            liveSessionStats.total++;
            updateLiveStats();
            renderLiveScansTable();
        }

        function showLiveStatus(type, text, detail) {
            const card = document.getElementById('liveStatusCard');
            const icon = document.getElementById('liveStatusIcon');
            const textEl = document.getElementById('liveStatusText');
            const detailEl = document.getElementById('liveStatusDetail');

            card.classList.remove('hidden', 'bg-green-100', 'border-green-500', 'bg-red-100', 'border-red-500', 'bg-yellow-100', 'border-yellow-500');

            if (type === 'success') {
                card.className = 'mb-6 p-8 rounded-lg border-4 text-center bg-green-100 border-green-500';
                icon.innerHTML = 'âœ…';
                textEl.className = 'text-4xl font-bold mb-2 text-green-800';
            } else if (type === 'error') {
                card.className = 'mb-6 p-8 rounded-lg border-4 text-center bg-red-100 border-red-500';
                icon.innerHTML = 'âŒ';
                textEl.className = 'text-4xl font-bold mb-2 text-red-800';
            } else if (type === 'duplicate') {
                card.className = 'mb-6 p-8 rounded-lg border-4 text-center bg-yellow-100 border-yellow-500';
                icon.innerHTML = 'âš ï¸';
                textEl.className = 'text-4xl font-bold mb-2 text-yellow-800';
            }

            textEl.textContent = text;
            detailEl.textContent = detail;
            detailEl.className = 'text-2xl text-gray-700';

            // Auto hide after 2 seconds
            setTimeout(() => {
                card.classList.add('hidden');
            }, 2000);
        }

        function updateLiveStats() {
            document.getElementById('liveStatMatched').textContent = liveSessionStats.matched;
            document.getElementById('liveStatVariance').textContent = liveSessionStats.variance;
            document.getElementById('liveStatDuplicate').textContent = liveSessionStats.duplicate;
            document.getElementById('liveStatTotal').textContent = liveSessionStats.total;
        }

        function renderLiveScansTable() {
            const tbody = document.getElementById('liveScansTableBody');
            if (liveSessionData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">No scans yet...</td></tr>';
                return;
            }

            const recent = liveSessionData.slice(0, 10);
            tbody.innerHTML = recent.map((scan, index) => {
                let statusClass = 'text-green-400';
                if (scan.status === 'VARIANCE') statusClass = 'text-red-400';
                if (scan.status === 'DUPLICATE') statusClass = 'text-yellow-400';

                return `
                    <tr class="border-b border-gray-700 hover:bg-gray-700">
                        <td class="p-2">${liveSessionData.length - index}</td>
                        <td class="p-2 font-mono text-xs">${scan.time}</td>
                        <td class="p-2 font-mono">${scan.mat}</td>
                        <td class="p-2 font-mono">${scan.batch}</td>
                        <td class="p-2 font-mono">${scan.ser}</td>
                        <td class="p-2 font-bold ${statusClass}">${scan.status}</td>
                        <td class="p-2 text-xs text-gray-400">${scan.detail}</td>
                    </tr>
                `;
            }).join('');
        }

        function finishLiveSession() {
            if (liveSessionData.length === 0) {
                alert("No scans to export!");
                return;
            }

            // Export to Excel
            const header = [
                { v: 'S.No', t: 's', s: { font: { bold: true } } },
                { v: 'Time', t: 's', s: { font: { bold: true } } },
                { v: 'Condition', t: 's', s: { font: { bold: true } } },
                { v: 'Material', t: 's', s: { font: { bold: true } } },
                { v: 'Batch', t: 's', s: { font: { bold: true } } },
                { v: 'Serial', t: 's', s: { font: { bold: true } } },
                { v: 'Status', t: 's', s: { font: { bold: true } } },
                { v: 'Detail', t: 's', s: { font: { bold: true } } },
                { v: 'Barcode', t: 's', s: { font: { bold: true } } }
            ];

            const rows = liveSessionData.reverse().map((scan, index) => [
                { v: index + 1, t: 'n' },
                { v: scan.time, t: 's' },
                { v: scan.condition || 'Good', t: 's' },
                { v: scan.mat, t: 's' },
                { v: scan.batch, t: 's' },
                { v: scan.ser, t: 's' },
                { v: scan.status, t: 's' },
                { v: scan.detail, t: 's' },
                { v: scan.barcode, t: 's' }
            ]);

            const ws = XLSX.utils.aoa_to_sheet([header, ...rows]);
            ws['!cols'] = [{ wch: 6 }, { wch: 12 }, { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 12 }, { wch: 30 }, { wch: 40 }];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Live Scan Session");

            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            XLSX.writeFile(wb, `LiveScan_Session_${timestamp}.xlsx`);

            alert(`âœ… Session exported!\n\nMatched: ${liveSessionStats.matched}\nVariance: ${liveSessionStats.variance}\nDuplicates: ${liveSessionStats.duplicate}\nTotal: ${liveSessionStats.total}`);

            closeLiveScanMode();
        }

        // --- DIAGNOSTICS / AUTO-TEST ---
        async function runDiagnostics() {
            if (!confirm("âš ï¸ WARNING: This will clear your current session and load TEST DATA. Continue?")) return;

            // 1. Setup Mock System File
            const mockSysData = [
                ["Material", "Batch", "Serial", "Qty", "Description"],
                ["MAT_EXACT", "BATCH1", "SER1", "10", "Exact Match Test"],
                ["MAT_BATCH", "BATCH2", "SER_SYS", "10", "Batch Match Test"],
                ["MAT_ONLY", "BATCH_SYS", "SER_SYS", "10", "Material Match Test"],
                ["MAT_VAR", "B", "S", "1", "Variance Test"],
                ["MAT_PARTIAL", "B", "S", "2", "Partial Qty Test"]
            ];

            // 2. Setup Mock Scan File
            const mockScanData = [
                ["Scan", "Qty", "Condition"],
                ["(01)MAT_EXACT(10)BATCH1(21)SER1", "1", ""], // Exact
                ["(01)MAT_BATCH(10)BATCH2(21)SER_SCAN", "1", ""], // Batch Only
                ["(01)MAT_ONLY(10)BATCH_SCAN(21)SER_SCAN", "1", ""], // Material Only
                ["(01)MAT_UNKNOWN(10)B(21)S", "1", ""], // Variance
                ["(01)MAT_PARTIAL(10)B(21)S", "3", ""] // Sys 2, Scan 3 -> Expect Matched=2, Var=1
            ];

            const mockSysFile = { isMock: true, data: mockSysData, name: "TEST_SYSTEM.xlsx" };
            const mockScanFile = { isMock: true, data: mockScanData, name: "TEST_SCAN.xlsx" };

            // 3. Load System Data
            updateProgress(10, "Loading Diagnostic Data...");
            await loadSystemInventory(mockSysFile);

            // 4. Trigger Validation
            // We set global file variables to our mocks
            // (Assuming fSys/fScan are globally accessible as seen in actualValidation usage)
            try { fSys = mockSysFile; } catch (e) { window.fSys = mockSysFile; }
            try { fScan = mockScanFile; } catch (e) { window.fScan = mockScanFile; }

            // Ensure settings
            if (document.getElementById('useScanQty')) document.getElementById('useScanQty').checked = true;

            await actualValidation();

            setTimeout(() => alert("âœ… Auto-Test Complete!\n\nCheck Dashboard:\n- Exact Match: 1\n- Batch Match: 1\n- Material Match: 1\n- Variance: 2 (1 Unknown, 1 Partial)"), 500);
        }

        // --- LAYOUT MIGRATION ---
        function ensureLayoutCompatibility() {
            if (typeof layouts === 'undefined') return;
            const newKeys = ['billDoc', 'billDate', 'mat', 'desc'];
            let updated = false;
            for (const id in layouts) {
                const layout = layouts[id];
                if (!layout.columns) continue;
                newKeys.forEach(key => {
                    const exists = layout.columns.find(c => c.key === key);
                    if (!exists) {
                        // Find definition in ALL_COLUMNS or create default
                        let def = (typeof ALL_COLUMNS !== 'undefined') ? ALL_COLUMNS.find(c => c.key === key) : null;
                        if (!def) {
                            if (key === 'billDoc') def = { key: 'billDoc', label: 'Billing Doc', default: true };
                            if (key === 'billDate') def = { key: 'billDate', label: 'Billing Date', default: true };
                        }
                        if (def) {
                            layout.columns.push({ ...def, visible: true, width: 100 });
                            updated = true;
                        }
                    }
                });
            }
            if (updated && typeof saveLayoutsToStorage === 'function') saveLayoutsToStorage();
            else if (updated) localStorage.setItem('inventoryLayouts_v13', JSON.stringify(layouts));
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            ensureLayoutCompatibility();
            const liveScanInput = document.getElementById('liveScanInput');
            if (liveScanInput) {
                liveScanInput.addEventListener('change', (e) => {
                    if (liveScanActive && !liveScanPaused) {
                        validateLiveScan(e.target.value);
                        e.target.value = '';
                        e.target.focus();
                    }
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Global Shortcuts
                    if (e.altKey && (e.key === 'f' || e.key === 'F')) {
                        e.preventDefault();
                        const search = document.getElementById('searchBox');
                        if (search) search.focus();
                        return;
                    }
                    if (e.ctrlKey && e.shiftKey && (e.key === 'l' || e.key === 'L')) {
                        e.preventDefault();
                        if (typeof clearAllFilters === 'function') clearAllFilters();
                        return;
                    }

                    if (e.key === 'Escape') {
                        const panel = document.querySelector('.super-filter-panel');
                        if (panel) panel.remove();
                        // Close Modals (except Live Scan which has specific close)
                        const modals = ['preValidationModal', 'duplicateDetailsModal', 'colVisModal', 'updatesModal', 'aboutModal', 'layoutModal'];
                        modals.forEach(id => document.getElementById(id).classList.add('hidden'));

                        if (typeof liveScanActive !== 'undefined' && liveScanActive) closeLiveScanMode();
                        return;
                    }

                    if (!liveScanActive) return;

                    if (e.key === 'p' || e.key === 'P') {
                        toggleLivePause();
                    }
                });
            }
        });
    </script>

    <div id="layoutModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div class="bg-white w-full max-w-4xl h-[80vh] rounded-lg shadow-2xl flex flex-col overflow-hidden">
            <div class="bg-gray-900 text-white p-4 flex justify-between items-center">
                <h3 class="font-bold text-lg">Advanced Layout Manager</h3>
                <button onclick="document.getElementById('layoutModal').classList.add('hidden')"
                    class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            <div class="flex flex-1 overflow-hidden">
                <div class="w-1/3 bg-gray-50 border-r p-0 flex flex-col">
                    <div class="p-3 border-b font-bold text-gray-500 text-xs uppercase">Saved Layouts</div>
                    <div id="savedLayoutsList" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
                    <div class="p-3 border-t"><button onclick="createNewLayout()"
                            class="w-full bg-blue-600 text-white py-2 rounded font-bold text-sm">Create New</button>
                    </div>
                </div>
                <div class="w-2/3 flex flex-col bg-white">
                    <div class="p-4 border-b flex justify-between bg-gray-100">
                        <input type="text" id="layoutNameInput" placeholder="Layout Name"
                            class="border p-2 rounded w-1/2 text-sm font-bold">
                        <div>
                            <button onclick="saveCurrentLayout()"
                                class="bg-green-600 text-white px-4 py-2 rounded text-sm font-bold mr-2">Save</button>
                            <button onclick="deleteCurrentLayout()"
                                class="bg-red-500 text-white px-4 py-2 rounded text-sm font-bold">Delete</button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4">
                        <div class="grid grid-cols-12 gap-2 text-xs font-bold text-gray-500 border-b pb-2 mb-2">
                            <div class="col-span-1 text-center">Show</div>
                            <div class="col-span-4">Field</div>
                            <div class="col-span-4">Excel Header</div>
                            <div class="col-span-1">Width</div>
                            <div class="col-span-2 text-center">Order</div>
                        </div>
                        <div id="columnEditorList" class="space-y-1"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Scan Mode Overlay -->
    <div id="liveScanModal" class="hidden fixed inset-0 bg-gray-900 z-50 flex flex-col">
        <!-- Header -->
        <div class="bg-red-600 text-white p-4 flex justify-between items-center shadow-lg">
            <div class="flex items-center gap-3">
                <i class="fas fa-circle animate-pulse text-2xl"></i>
                <h2 class="text-2xl font-bold">LIVE SCAN MODE - ACTIVE</h2>
            </div>

            <!-- Condition Toggle -->
            <div class="flex bg-black bg-opacity-30 rounded p-1">
                <button id="btnCondGood" onclick="setLiveCondition('Good')"
                    class="px-6 py-2 rounded font-bold bg-green-500 text-white shadow ring-2 ring-white">
                    <i class="fas fa-check-circle mr-2"></i> GOOD
                </button>
                <button id="btnCondDamage" onclick="setLiveCondition('Damage')"
                    class="px-6 py-2 rounded font-bold bg-transparent text-gray-300 hover:text-white transition">
                    <i class="fas fa-times-circle mr-2"></i> DAMAGE
                </button>
            </div>

            <div class="flex items-center gap-4">
                <button id="livePauseBtn" onclick="toggleLivePause()"
                    class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded font-bold">
                    <i class="fas fa-pause mr-2"></i> PAUSE
                </button>
                <button onclick="closeLiveScanMode()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded font-bold">
                    <i class="fas fa-times mr-2"></i> EXIT
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col p-6 overflow-hidden">
            <!-- Input Box -->
            <div class="mb-6">
                <label class="text-white text-lg font-bold mb-2 block">SCAN BARCODE:</label>
                <input type="text" id="liveScanInput"
                    class="w-full p-4 text-2xl font-mono border-4 border-blue-500 rounded focus:outline-none focus:border-green-500"
                    placeholder="Focus here and scan..." autocomplete="off">
            </div>

            <!-- Status Card -->
            <div id="liveStatusCard" class="mb-6 p-8 rounded-lg border-4 text-center hidden">
                <div id="liveStatusIcon" class="text-8xl mb-4"></div>
                <div id="liveStatusText" class="text-4xl font-bold mb-2"></div>
                <div id="liveStatusDetail" class="text-2xl"></div>
            </div>

            <!-- Statistics Panel -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="bg-green-700 p-4 rounded text-center">
                    <div class="text-white text-sm font-bold mb-1">MATCHED</div>
                    <div id="liveStatMatched" class="text-white text-4xl font-bold">0</div>
                </div>
                <div class="bg-red-700 p-4 rounded text-center">
                    <div class="text-white text-sm font-bold mb-1">VARIANCE</div>
                    <div id="liveStatVariance" class="text-white text-4xl font-bold">0</div>
                </div>
                <div class="bg-yellow-600 p-4 rounded text-center">
                    <div class="text-white text-sm font-bold mb-1">DUPLICATES</div>
                    <div id="liveStatDuplicate" class="text-white text-4xl font-bold">0</div>
                </div>
                <div class="bg-blue-700 p-4 rounded text-center">
                    <div class="text-white text-sm font-bold mb-1">TOTAL SCANS</div>
                    <div id="liveStatTotal" class="text-white text-4xl font-bold">0</div>
                </div>
            </div>

            <!-- Recent Scans Table -->
            <div class="flex-1 bg-gray-800 rounded overflow-hidden flex flex-col">
                <div class="bg-gray-700 p-3 text-white font-bold text-sm">RECENT SCANS (Last 10)</div>
                <div class="flex-1 overflow-y-auto">
                    <table class="w-full text-white text-sm">
                        <thead class="bg-gray-700 sticky top-0">
                            <tr>
                                <th class="p-2 text-left">#</th>
                                <th class="p-2 text-left">Time</th>
                                <th class="p-2 text-left">Material</th>
                                <th class="p-2 text-left">Batch</th>
                                <th class="p-2 text-left">Serial</th>
                                <th class="p-2 text-left">Status</th>
                                <th class="p-2 text-left">Detail</th>
                            </tr>
                        </thead>
                        <tbody id="liveScansTableBody">
                            <tr>
                                <td colspan="7" class="p-4 text-center text-gray-500">No scans yet...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Footer Controls -->
        <div class="bg-gray-800 p-4 flex justify-between items-center border-t border-gray-700">
            <div class="text-white text-sm">
                <kbd class="bg-gray-700 px-2 py-1 rounded">ESC</kbd> Exit |
                <kbd class="bg-gray-700 px-2 py-1 rounded">P</kbd> Pause/Resume
            </div>
            <button onclick="finishLiveSession()"
                class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded font-bold text-lg">
                <i class="fas fa-check-circle mr-2"></i> FINISH & EXPORT
            </button>
        </div>
    </div>
</body>

</html>
